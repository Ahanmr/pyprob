;; gorilla-repl.fileformat = 1

;; **
;;; # Dirichlet Process Mixture Model - stick breaking construction
;; **

;; @@
(ns worksheets.dirichlet-process-mixture-stick-breaking
  (:require [anglican.runtime :refer :all]
            [anglican.emit :refer [defquery with-primitive-procedures defm]]
            [anglican.stat :refer [empirical-distribution collect-predicts collect-by collect-results]]
            [anglican.core :refer [doquery]]
            [anglican.state :refer [get-predicts]]
            anglican.infcomp.csis
            anglican.importance
            anglican.smc
            anglican.pgibbs
            anglican.infcomp.core
            [anglican.infcomp.dists :refer :all]
            [anglican.infcomp.network :refer :all]
            [anglican.infcomp.prior :refer :all]
            [anglican.inference :refer [infer]]
            [gorilla-plot.core :as plot]))

(anglican.infcomp.core/reset-infcomp-addressing-scheme!)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#function[anglican.infcomp.core/reset-infcomp-addressing-scheme!$fn--27378$fn--27379]</span>","value":"#function[anglican.infcomp.core/reset-infcomp-addressing-scheme!$fn--27378$fn--27379]"}
;; <=

;; @@
(defm create-sethuraman-stick-breaking-process
  [concentration]
  (let
    [
      ; sethuraman-stick-breaking-rule returns 
      ; a stick length via the one-parameter 
      ; stick breaking rule which closes
      ; over concentration
      sethuraman-stick-breaking-rule 
      (mem (fn [k] (sample* (beta 1 concentration))))

      ; sample-stick-index is a procedure that 
      ; samples an index from a potentially 
      ; infinite dimensional discrete distribution 
      ; lazily constructed by a stick breaking rule
      sample-stick-index 
      (fn sample-stick-index [k] 
        (if (sample* (flip (sethuraman-stick-breaking-rule k))) 
          k 
          (sample-stick-index (+ k 1))))

      ; wrapping a stick breaking process to return it
      stick-breaking-process 
      (fn [] (sample-stick-index 1))]
    stick-breaking-process))

(defm DPmem
  "DPmem is a procedure that takes two arguments -- 
  the concentration to a Dirichlet process
  and a base sampling procedure. DPmem returns a procedure."
  [concentration base]
  (let [get-value-from-cache-or-sample 
        (mem 
          (fn [args stick-index] 
            (apply base args)))
        get-stick-picking-procedure-from-cache 
        (mem 
          (fn [args] 
            (create-sethuraman-stick-breaking-process 
              concentration)))]
    (fn [& varargs]
      ; when the returned function is called, 
      ; the first thing it does is get
      ; the cached stick breaking procedure 
      ; for the passed in arguments
      ; and _calls_ it to get an index
      (let [index ((get-stick-picking-procedure-from-cache 
                     varargs))]
        ; if, for the given set of arguments 
        ; and just sampled index a return value has already 
        ; been computed, get it from the cache
        ; and return it, otherwise sample a new value
        (get-value-from-cache-or-sample varargs index)))))

(defquery dirichlet-process-mixture-stick-breaking
  [input-data]
  (let
    [concentration 1.72
     base (fn []
            (let [v (/ 1.0 (sample (gamma 1 10)))]
              (list (sample (normal 0 (sqrt (* v 10)))) 
                    (sqrt v))))
     obs-param (DPmem concentration base)]

    ; observe draws from the DP mixture
    (map
      (fn [value]
        (observe (apply normal (obs-param)) value))
      input-data)

    ; predict a data point from the DP mixture
    (sample (apply normal (obs-param)))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/dirichlet-process-mixture-stick-breaking</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/dirichlet-process-mixture-stick-breaking"}
;; <=

;; **
;;; ## Inference compilation
;;; 
;;; Specify a function `combine-observes-fn` that combines observes from a sample in a form suitable for Torch:
;; **

;; @@
(sample-samples-from-prior dirichlet-process-mixture-stick-breaking [(repeat 8 nil)])
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:time-index 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xb675c66 &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@b675c66&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xb675c66 \"anglican.infcomp.flatbuffers.gamma.GammaClj@b675c66\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xb675c66 \"anglican.infcomp.flatbuffers.gamma.GammaClj@b675c66\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.012809161048585567</span>","value":"0.012809161048585567"}],"value":"[:value 0.012809161048585567]"}],"value":"{:time-index 0, :sample-address \"S65\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xb675c66 \"anglican.infcomp.flatbuffers.gamma.GammaClj@b675c66\"], :value 0.012809161048585567}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:time-index 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x39c17949 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@39c17949&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x39c17949 \"anglican.infcomp.flatbuffers.normal.NormalClj@39c17949\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x39c17949 \"anglican.infcomp.flatbuffers.normal.NormalClj@39c17949\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>31.834217106515744</span>","value":"31.834217106515744"}],"value":"[:value 31.834217106515744]"}],"value":"{:time-index 1, :sample-address \"S61\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x39c17949 \"anglican.infcomp.flatbuffers.normal.NormalClj@39c17949\"], :value 31.834217106515744}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:time-index 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:sample-instance 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x345cce8b &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@345cce8b&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x345cce8b \"anglican.infcomp.flatbuffers.gamma.GammaClj@345cce8b\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x345cce8b \"anglican.infcomp.flatbuffers.gamma.GammaClj@345cce8b\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.12158392072894988</span>","value":"0.12158392072894988"}],"value":"[:value 0.12158392072894988]"}],"value":"{:time-index 2, :sample-address \"S65\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x345cce8b \"anglican.infcomp.flatbuffers.gamma.GammaClj@345cce8b\"], :value 0.12158392072894988}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>3</span>","value":"3"}],"value":"[:time-index 3]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:sample-instance 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x7ab67247 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@7ab67247&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x7ab67247 \"anglican.infcomp.flatbuffers.normal.NormalClj@7ab67247\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x7ab67247 \"anglican.infcomp.flatbuffers.normal.NormalClj@7ab67247\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>17.76704064516511</span>","value":"17.76704064516511"}],"value":"[:value 17.76704064516511]"}],"value":"{:time-index 3, :sample-address \"S61\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x7ab67247 \"anglican.infcomp.flatbuffers.normal.NormalClj@7ab67247\"], :value 17.76704064516511}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>4</span>","value":"4"}],"value":"[:time-index 4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:sample-instance 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x4b83851b &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@4b83851b&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x4b83851b \"anglican.infcomp.flatbuffers.gamma.GammaClj@4b83851b\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x4b83851b \"anglican.infcomp.flatbuffers.gamma.GammaClj@4b83851b\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.06559393539867266</span>","value":"0.06559393539867266"}],"value":"[:value 0.06559393539867266]"}],"value":"{:time-index 4, :sample-address \"S65\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x4b83851b \"anglican.infcomp.flatbuffers.gamma.GammaClj@4b83851b\"], :value 0.06559393539867266}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>5</span>","value":"5"}],"value":"[:time-index 5]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:sample-instance 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x79bab613 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@79bab613&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x79bab613 \"anglican.infcomp.flatbuffers.normal.NormalClj@79bab613\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x79bab613 \"anglican.infcomp.flatbuffers.normal.NormalClj@79bab613\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>12.178014003540383</span>","value":"12.178014003540383"}],"value":"[:value 12.178014003540383]"}],"value":"{:time-index 5, :sample-address \"S61\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x79bab613 \"anglican.infcomp.flatbuffers.normal.NormalClj@79bab613\"], :value 12.178014003540383}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>6</span>","value":"6"}],"value":"[:time-index 6]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S46&quot;</span>","value":"\"S46\""}],"value":"[:sample-address \"S46\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x2b400739 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@2b400739&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x2b400739 \"anglican.infcomp.flatbuffers.normal.NormalClj@2b400739\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x2b400739 \"anglican.infcomp.flatbuffers.normal.NormalClj@2b400739\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>10.955332897764961</span>","value":"10.955332897764961"}],"value":"[:value 10.955332897764961]"}],"value":"{:time-index 6, :sample-address \"S46\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x2b400739 \"anglican.infcomp.flatbuffers.normal.NormalClj@2b400739\"], :value 10.955332897764961}"}],"value":"[{:time-index 0, :sample-address \"S65\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xb675c66 \"anglican.infcomp.flatbuffers.gamma.GammaClj@b675c66\"], :value 0.012809161048585567} {:time-index 1, :sample-address \"S61\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x39c17949 \"anglican.infcomp.flatbuffers.normal.NormalClj@39c17949\"], :value 31.834217106515744} {:time-index 2, :sample-address \"S65\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x345cce8b \"anglican.infcomp.flatbuffers.gamma.GammaClj@345cce8b\"], :value 0.12158392072894988} {:time-index 3, :sample-address \"S61\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x7ab67247 \"anglican.infcomp.flatbuffers.normal.NormalClj@7ab67247\"], :value 17.76704064516511} {:time-index 4, :sample-address \"S65\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x4b83851b \"anglican.infcomp.flatbuffers.gamma.GammaClj@4b83851b\"], :value 0.06559393539867266} {:time-index 5, :sample-address \"S61\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x79bab613 \"anglican.infcomp.flatbuffers.normal.NormalClj@79bab613\"], :value 12.178014003540383} {:time-index 6, :sample-address \"S46\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x2b400739 \"anglican.infcomp.flatbuffers.normal.NormalClj@2b400739\"], :value 10.955332897764961}]"}
;; <=

;; @@
(defn combine-observes-fn [observes]
  (map :value observes))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/combine-observes-fn</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/combine-observes-fn"}
;; <=

;; @@
(def torch-connection (start-torch-connection dirichlet-process-mixture-stick-breaking [(repeat 8 nil)] combine-observes-fn))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/torch-connection</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/torch-connection"}
;; <=

;; @@
(stop-torch-connection torch-connection)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-string'>&quot;Torch connection terminated.&quot;</span>","value":"\"Torch connection terminated.\""}
;; <=

;; **
;;; ## Inference
;; **

;; @@
(def test-observations
  [-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
   7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
   3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3])

(def test-observations
  [1.45 1 0.9 2.5 7.8 8.2 7.9 7.8])
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/test-observations</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/test-observations"}
;; <=

;; **
;;; ### Infcomp
;;; 
;;; First, run the inference server from torch-infcomp:
;;; 
;;; `python -m infcomp.infer`
;;; 
;;; Then run the query, specifying number of particles:
;; **

;; @@
(def num-particles 100)
(def csis-states (take num-particles (infer :csis dirichlet-process-mixture-stick-breaking [test-observations])))
(plot/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results csis-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba","values":[{"x":-5.252033598226039,"y":0},{"x":-4.784000964637192,"y":0.01281961890988744},{"x":-4.315968331048345,"y":0.0},{"x":-3.8479356974594983,"y":0.0},{"x":-3.3799030638706515,"y":0.0},{"x":-2.911870430281805,"y":0.0},{"x":-2.443837796692958,"y":0.0},{"x":-1.9758051631041114,"y":0.0},{"x":-1.5077725295152646,"y":0.0},{"x":-1.039739895926418,"y":0.0},{"x":-0.5717072623375711,"y":0.0},{"x":-0.10367462874872424,"y":0.008546412606591626},{"x":0.3643580048401226,"y":0.0},{"x":0.8323906384289694,"y":0.0},{"x":1.3004232720178162,"y":0.16879164898018462},{"x":1.7684559056066629,"y":0.004273206303295813},{"x":2.2364885391955096,"y":0.0},{"x":2.7045211727843563,"y":0.057688285094493474},{"x":3.172553806373203,"y":0.28416821916917157},{"x":3.64058643996205,"y":0.15810863322194507},{"x":4.108619073550897,"y":0.0},{"x":4.576651707139744,"y":0.01281961890988744},{"x":5.044684340728591,"y":0.0},{"x":5.5127169743174385,"y":0.019229428364831158},{"x":5.980749607906286,"y":0.20725050570984693},{"x":6.448782241495133,"y":0.0},{"x":6.91681487508398,"y":0.0341856504263665},{"x":7.384847508672827,"y":0.0},{"x":7.852880142261674,"y":0.0662346977010851},{"x":8.320912775850521,"y":0.0021366031516479064},{"x":8.788945409439368,"y":0.14528901431205762},{"x":9.256978043028214,"y":0.0},{"x":9.72501067661706,"y":0.8610510701141063},{"x":10.193043310205907,"y":0.047005269336253944},{"x":10.661075943794753,"y":0.02563923781977488},{"x":11.1291085773836,"y":0.0},{"x":11.597141210972445,"y":0.0},{"x":12.065173844561292,"y":0.0021366031516479064},{"x":12.533206478150138,"y":0.0},{"x":13.001239111738984,"y":0.0},{"x":13.46927174532783,"y":0.0},{"x":13.937304378916677,"y":0.0},{"x":14.405337012505523,"y":0.0},{"x":14.87336964609437,"y":0.0},{"x":15.341402279683216,"y":0.0},{"x":15.809434913272062,"y":0.0},{"x":16.27746754686091,"y":0.0},{"x":16.745500180449756,"y":0.0},{"x":17.213532814038604,"y":0.0},{"x":17.681565447627452,"y":0.0},{"x":18.1495980812163,"y":0.00640980945494372},{"x":18.61763071480515,"y":0.0},{"x":19.085663348393997,"y":0.0},{"x":19.553695981982845,"y":0.0},{"x":20.021728615571693,"y":0.0},{"x":20.48976124916054,"y":0.0},{"x":20.95779388274939,"y":0.0},{"x":21.425826516338237,"y":0.0},{"x":21.893859149927085,"y":0.0},{"x":22.361891783515933,"y":0.0},{"x":22.82992441710478,"y":0.0},{"x":23.29795705069363,"y":0.0},{"x":23.765989684282477,"y":0.0},{"x":24.234022317871325,"y":0.0},{"x":24.702054951460173,"y":0.0},{"x":25.17008758504902,"y":0.0},{"x":25.63812021863787,"y":0.0},{"x":26.106152852226717,"y":0.0},{"x":26.574185485815565,"y":0.0},{"x":27.042218119404414,"y":0.0},{"x":27.51025075299326,"y":0.0},{"x":27.97828338658211,"y":0.0},{"x":28.446316020170958,"y":0.0},{"x":28.914348653759806,"y":0.0},{"x":29.382381287348654,"y":0.0},{"x":29.850413920937502,"y":0.0},{"x":30.31844655452635,"y":0.0},{"x":30.786479188115198,"y":0.0},{"x":31.254511821704046,"y":0.0},{"x":31.722544455292894,"y":0.0},{"x":32.19057708888174,"y":0.0},{"x":32.65860972247059,"y":0.0},{"x":33.126642356059435,"y":0.0},{"x":33.59467498964828,"y":0.0},{"x":34.06270762323713,"y":0.0},{"x":34.53074025682598,"y":0.0},{"x":34.99877289041483,"y":0.0},{"x":35.466805524003675,"y":0.0},{"x":35.93483815759252,"y":0.0},{"x":36.40287079118137,"y":0.0},{"x":36.87090342477022,"y":0.0},{"x":37.33893605835907,"y":0.0},{"x":37.806968691947915,"y":0.0},{"x":38.27500132553676,"y":0.0},{"x":38.74303395912561,"y":0.0},{"x":39.21106659271446,"y":0.0},{"x":39.67909922630331,"y":0.0},{"x":40.147131859892156,"y":0.0},{"x":40.615164493481004,"y":0.0},{"x":41.08319712706985,"y":0.0},{"x":41.5512297606587,"y":0.01281961890988744},{"x":42.01926239424755,"y":0}]}],"marks":[{"type":"line","from":{"data":"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba\", :values ({:x -5.252033598226039, :y 0} {:x -4.784000964637192, :y 0.01281961890988744} {:x -4.315968331048345, :y 0.0} {:x -3.8479356974594983, :y 0.0} {:x -3.3799030638706515, :y 0.0} {:x -2.911870430281805, :y 0.0} {:x -2.443837796692958, :y 0.0} {:x -1.9758051631041114, :y 0.0} {:x -1.5077725295152646, :y 0.0} {:x -1.039739895926418, :y 0.0} {:x -0.5717072623375711, :y 0.0} {:x -0.10367462874872424, :y 0.008546412606591626} {:x 0.3643580048401226, :y 0.0} {:x 0.8323906384289694, :y 0.0} {:x 1.3004232720178162, :y 0.16879164898018462} {:x 1.7684559056066629, :y 0.004273206303295813} {:x 2.2364885391955096, :y 0.0} {:x 2.7045211727843563, :y 0.057688285094493474} {:x 3.172553806373203, :y 0.28416821916917157} {:x 3.64058643996205, :y 0.15810863322194507} {:x 4.108619073550897, :y 0.0} {:x 4.576651707139744, :y 0.01281961890988744} {:x 5.044684340728591, :y 0.0} {:x 5.5127169743174385, :y 0.019229428364831158} {:x 5.980749607906286, :y 0.20725050570984693} {:x 6.448782241495133, :y 0.0} {:x 6.91681487508398, :y 0.0341856504263665} {:x 7.384847508672827, :y 0.0} {:x 7.852880142261674, :y 0.0662346977010851} {:x 8.320912775850521, :y 0.0021366031516479064} {:x 8.788945409439368, :y 0.14528901431205762} {:x 9.256978043028214, :y 0.0} {:x 9.72501067661706, :y 0.8610510701141063} {:x 10.193043310205907, :y 0.047005269336253944} {:x 10.661075943794753, :y 0.02563923781977488} {:x 11.1291085773836, :y 0.0} {:x 11.597141210972445, :y 0.0} {:x 12.065173844561292, :y 0.0021366031516479064} {:x 12.533206478150138, :y 0.0} {:x 13.001239111738984, :y 0.0} {:x 13.46927174532783, :y 0.0} {:x 13.937304378916677, :y 0.0} {:x 14.405337012505523, :y 0.0} {:x 14.87336964609437, :y 0.0} {:x 15.341402279683216, :y 0.0} {:x 15.809434913272062, :y 0.0} {:x 16.27746754686091, :y 0.0} {:x 16.745500180449756, :y 0.0} {:x 17.213532814038604, :y 0.0} {:x 17.681565447627452, :y 0.0} {:x 18.1495980812163, :y 0.00640980945494372} {:x 18.61763071480515, :y 0.0} {:x 19.085663348393997, :y 0.0} {:x 19.553695981982845, :y 0.0} {:x 20.021728615571693, :y 0.0} {:x 20.48976124916054, :y 0.0} {:x 20.95779388274939, :y 0.0} {:x 21.425826516338237, :y 0.0} {:x 21.893859149927085, :y 0.0} {:x 22.361891783515933, :y 0.0} {:x 22.82992441710478, :y 0.0} {:x 23.29795705069363, :y 0.0} {:x 23.765989684282477, :y 0.0} {:x 24.234022317871325, :y 0.0} {:x 24.702054951460173, :y 0.0} {:x 25.17008758504902, :y 0.0} {:x 25.63812021863787, :y 0.0} {:x 26.106152852226717, :y 0.0} {:x 26.574185485815565, :y 0.0} {:x 27.042218119404414, :y 0.0} {:x 27.51025075299326, :y 0.0} {:x 27.97828338658211, :y 0.0} {:x 28.446316020170958, :y 0.0} {:x 28.914348653759806, :y 0.0} {:x 29.382381287348654, :y 0.0} {:x 29.850413920937502, :y 0.0} {:x 30.31844655452635, :y 0.0} {:x 30.786479188115198, :y 0.0} {:x 31.254511821704046, :y 0.0} {:x 31.722544455292894, :y 0.0} {:x 32.19057708888174, :y 0.0} {:x 32.65860972247059, :y 0.0} {:x 33.126642356059435, :y 0.0} {:x 33.59467498964828, :y 0.0} {:x 34.06270762323713, :y 0.0} {:x 34.53074025682598, :y 0.0} {:x 34.99877289041483, :y 0.0} {:x 35.466805524003675, :y 0.0} {:x 35.93483815759252, :y 0.0} {:x 36.40287079118137, :y 0.0} {:x 36.87090342477022, :y 0.0} {:x 37.33893605835907, :y 0.0} {:x 37.806968691947915, :y 0.0} {:x 38.27500132553676, :y 0.0} {:x 38.74303395912561, :y 0.0} {:x 39.21106659271446, :y 0.0} {:x 39.67909922630331, :y 0.0} {:x 40.147131859892156, :y 0.0} {:x 40.615164493481004, :y 0.0} {:x 41.08319712706985, :y 0.0} {:x 41.5512297606587, :y 0.01281961890988744} {:x 42.01926239424755, :y 0})}], :marks [{:type \"line\", :from {:data \"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"4e49c4e7-ddfe-4312-bb3f-c1f3600f07ba\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; **
;;; ### IS
;; **

;; @@
(def num-particles 100)
(def is-states (take num-particles (infer :importance dirichlet-process-mixture-stick-breaking [test-observations])))
(plot/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results is-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"1c29b48e-29e6-4e14-a487-7fbff4363e74","values":[{"x":-29.92154534478879,"y":0},{"x":-29.472181249705123,"y":0.002225366937280133},{"x":-29.022817154621457,"y":0.0},{"x":-28.57345305953779,"y":0.0},{"x":-28.124088964454124,"y":0.0},{"x":-27.674724869370458,"y":0.0},{"x":-27.22536077428679,"y":0.0},{"x":-26.775996679203125,"y":0.0},{"x":-26.32663258411946,"y":0.0},{"x":-25.877268489035792,"y":0.0},{"x":-25.427904393952126,"y":0.0},{"x":-24.97854029886846,"y":0.0},{"x":-24.529176203784793,"y":0.0},{"x":-24.079812108701127,"y":0.0},{"x":-23.63044801361746,"y":0.0},{"x":-23.181083918533794,"y":0.0},{"x":-22.731719823450128,"y":0.0},{"x":-22.28235572836646,"y":0.0},{"x":-21.832991633282795,"y":0.0},{"x":-21.38362753819913,"y":0.0},{"x":-20.934263443115462,"y":0.0},{"x":-20.484899348031796,"y":0.0},{"x":-20.03553525294813,"y":0.0},{"x":-19.586171157864463,"y":0.0},{"x":-19.136807062780797,"y":0.0},{"x":-18.68744296769713,"y":0.0},{"x":-18.238078872613464,"y":0.0},{"x":-17.788714777529798,"y":0.0},{"x":-17.33935068244613,"y":0.0},{"x":-16.889986587362465,"y":0.0},{"x":-16.4406224922788,"y":0.0},{"x":-15.99125839719513,"y":0.0},{"x":-15.541894302111462,"y":0.0},{"x":-15.092530207027794,"y":0.0},{"x":-14.643166111944126,"y":0.0},{"x":-14.193802016860458,"y":0.0},{"x":-13.74443792177679,"y":0.0},{"x":-13.295073826693121,"y":0.0},{"x":-12.845709731609453,"y":0.0},{"x":-12.396345636525785,"y":0.6231027424384373},{"x":-11.946981541442117,"y":0.0},{"x":-11.497617446358449,"y":0.0},{"x":-11.04825335127478,"y":0.0},{"x":-10.598889256191113,"y":0.0},{"x":-10.149525161107444,"y":0.0},{"x":-9.700161066023776,"y":0.44507338745602665},{"x":-9.250796970940108,"y":0.002225366937280133},{"x":-8.80143287585644,"y":0.0},{"x":-8.352068780772772,"y":0.0},{"x":-7.902704685689105,"y":0.0},{"x":-7.453340590605437,"y":0.0},{"x":-7.00397649552177,"y":0.0},{"x":-6.554612400438103,"y":0.0},{"x":-6.1052483053544355,"y":0.0},{"x":-5.655884210270768,"y":0.0},{"x":-5.206520115187101,"y":0.0},{"x":-4.757156020103434,"y":0.0},{"x":-4.3077919250197665,"y":0.0},{"x":-3.858427829936099,"y":0.0},{"x":-3.409063734852431,"y":0.015577568560960932},{"x":-2.9596996397687634,"y":0.0},{"x":-2.5103355446850957,"y":0.0},{"x":-2.060971449601428,"y":0.0},{"x":-1.6116073545177603,"y":0.0},{"x":-1.1622432594340926,"y":0.0},{"x":-0.7128791643504249,"y":0.32490357284289945},{"x":-0.2635150692667572,"y":0.0},{"x":0.18584902581691043,"y":0.0},{"x":0.635213120900578,"y":0.0},{"x":1.0845772159842457,"y":0.0400566048710424},{"x":1.5339413110679134,"y":0.0},{"x":1.9833054061515811,"y":0.0},{"x":2.4326695012352486,"y":0.053408806494723196},{"x":2.8820335963189163,"y":0.0},{"x":3.331397691402584,"y":0.7121174199296426},{"x":3.7807617864862517,"y":0.0},{"x":4.230125881569919,"y":0.0},{"x":4.679489976653587,"y":0.0},{"x":5.128854071737254,"y":0.0},{"x":5.578218166820921,"y":0.0},{"x":6.0275822619045885,"y":0.0},{"x":6.476946356988256,"y":0.0},{"x":6.926310452071923,"y":0.0},{"x":7.37567454715559,"y":0.0},{"x":7.8250386422392575,"y":0.0},{"x":8.274402737322925,"y":0.0},{"x":8.723766832406593,"y":0.0},{"x":9.173130927490261,"y":0.0},{"x":9.62249502257393,"y":0.0},{"x":10.071859117657597,"y":0.0},{"x":10.521223212741265,"y":0.0},{"x":10.970587307824934,"y":0.0},{"x":11.419951402908602,"y":0.0},{"x":11.86931549799227,"y":0.0},{"x":12.318679593075938,"y":0.0},{"x":12.768043688159606,"y":0.0},{"x":13.217407783243274,"y":0.0},{"x":13.666771878326943,"y":0.0},{"x":14.11613597341061,"y":0.0},{"x":14.565500068494279,"y":0.0},{"x":15.014864163577947,"y":0.0},{"x":15.464228258661615,"y":0.0066761008118403995},{"x":15.913592353745283,"y":0}]}],"marks":[{"type":"line","from":{"data":"1c29b48e-29e6-4e14-a487-7fbff4363e74"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"1c29b48e-29e6-4e14-a487-7fbff4363e74","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"1c29b48e-29e6-4e14-a487-7fbff4363e74","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"1c29b48e-29e6-4e14-a487-7fbff4363e74\", :values ({:x -29.92154534478879, :y 0} {:x -29.472181249705123, :y 0.002225366937280133} {:x -29.022817154621457, :y 0.0} {:x -28.57345305953779, :y 0.0} {:x -28.124088964454124, :y 0.0} {:x -27.674724869370458, :y 0.0} {:x -27.22536077428679, :y 0.0} {:x -26.775996679203125, :y 0.0} {:x -26.32663258411946, :y 0.0} {:x -25.877268489035792, :y 0.0} {:x -25.427904393952126, :y 0.0} {:x -24.97854029886846, :y 0.0} {:x -24.529176203784793, :y 0.0} {:x -24.079812108701127, :y 0.0} {:x -23.63044801361746, :y 0.0} {:x -23.181083918533794, :y 0.0} {:x -22.731719823450128, :y 0.0} {:x -22.28235572836646, :y 0.0} {:x -21.832991633282795, :y 0.0} {:x -21.38362753819913, :y 0.0} {:x -20.934263443115462, :y 0.0} {:x -20.484899348031796, :y 0.0} {:x -20.03553525294813, :y 0.0} {:x -19.586171157864463, :y 0.0} {:x -19.136807062780797, :y 0.0} {:x -18.68744296769713, :y 0.0} {:x -18.238078872613464, :y 0.0} {:x -17.788714777529798, :y 0.0} {:x -17.33935068244613, :y 0.0} {:x -16.889986587362465, :y 0.0} {:x -16.4406224922788, :y 0.0} {:x -15.99125839719513, :y 0.0} {:x -15.541894302111462, :y 0.0} {:x -15.092530207027794, :y 0.0} {:x -14.643166111944126, :y 0.0} {:x -14.193802016860458, :y 0.0} {:x -13.74443792177679, :y 0.0} {:x -13.295073826693121, :y 0.0} {:x -12.845709731609453, :y 0.0} {:x -12.396345636525785, :y 0.6231027424384373} {:x -11.946981541442117, :y 0.0} {:x -11.497617446358449, :y 0.0} {:x -11.04825335127478, :y 0.0} {:x -10.598889256191113, :y 0.0} {:x -10.149525161107444, :y 0.0} {:x -9.700161066023776, :y 0.44507338745602665} {:x -9.250796970940108, :y 0.002225366937280133} {:x -8.80143287585644, :y 0.0} {:x -8.352068780772772, :y 0.0} {:x -7.902704685689105, :y 0.0} {:x -7.453340590605437, :y 0.0} {:x -7.00397649552177, :y 0.0} {:x -6.554612400438103, :y 0.0} {:x -6.1052483053544355, :y 0.0} {:x -5.655884210270768, :y 0.0} {:x -5.206520115187101, :y 0.0} {:x -4.757156020103434, :y 0.0} {:x -4.3077919250197665, :y 0.0} {:x -3.858427829936099, :y 0.0} {:x -3.409063734852431, :y 0.015577568560960932} {:x -2.9596996397687634, :y 0.0} {:x -2.5103355446850957, :y 0.0} {:x -2.060971449601428, :y 0.0} {:x -1.6116073545177603, :y 0.0} {:x -1.1622432594340926, :y 0.0} {:x -0.7128791643504249, :y 0.32490357284289945} {:x -0.2635150692667572, :y 0.0} {:x 0.18584902581691043, :y 0.0} {:x 0.635213120900578, :y 0.0} {:x 1.0845772159842457, :y 0.0400566048710424} {:x 1.5339413110679134, :y 0.0} {:x 1.9833054061515811, :y 0.0} {:x 2.4326695012352486, :y 0.053408806494723196} {:x 2.8820335963189163, :y 0.0} {:x 3.331397691402584, :y 0.7121174199296426} {:x 3.7807617864862517, :y 0.0} {:x 4.230125881569919, :y 0.0} {:x 4.679489976653587, :y 0.0} {:x 5.128854071737254, :y 0.0} {:x 5.578218166820921, :y 0.0} {:x 6.0275822619045885, :y 0.0} {:x 6.476946356988256, :y 0.0} {:x 6.926310452071923, :y 0.0} {:x 7.37567454715559, :y 0.0} {:x 7.8250386422392575, :y 0.0} {:x 8.274402737322925, :y 0.0} {:x 8.723766832406593, :y 0.0} {:x 9.173130927490261, :y 0.0} {:x 9.62249502257393, :y 0.0} {:x 10.071859117657597, :y 0.0} {:x 10.521223212741265, :y 0.0} {:x 10.970587307824934, :y 0.0} {:x 11.419951402908602, :y 0.0} {:x 11.86931549799227, :y 0.0} {:x 12.318679593075938, :y 0.0} {:x 12.768043688159606, :y 0.0} {:x 13.217407783243274, :y 0.0} {:x 13.666771878326943, :y 0.0} {:x 14.11613597341061, :y 0.0} {:x 14.565500068494279, :y 0.0} {:x 15.014864163577947, :y 0.0} {:x 15.464228258661615, :y 0.0066761008118403995} {:x 15.913592353745283, :y 0})}], :marks [{:type \"line\", :from {:data \"1c29b48e-29e6-4e14-a487-7fbff4363e74\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"1c29b48e-29e6-4e14-a487-7fbff4363e74\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"1c29b48e-29e6-4e14-a487-7fbff4363e74\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; **
;;; ### SMC
;; **

;; @@
(def num-particles 100)
(def smc-states (take num-particles (infer :smc dirichlet-process-mixture-stick-breaking [test-observations] :number-of-particles 100)))
(plot/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results smc-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3","values":[{"x":-17.586289928232812,"y":0},{"x":-15.59193298764728,"y":0.0030084885397888847},{"x":-13.597576047061747,"y":0.0060169770795777695},{"x":-11.603219106476214,"y":0.0},{"x":-9.608862165890681,"y":0.0030084885397888847},{"x":-7.614505225305147,"y":0.004011318053051847},{"x":-5.620148284719614,"y":0.02005659026525923},{"x":-3.62579134413408,"y":0.009025465619366655},{"x":-1.6314344035485462,"y":0.03158912966778329},{"x":0.3629225370369875,"y":0.028580641127994407},{"x":2.357279477622521,"y":0.055657037986094365},{"x":4.351636418208055,"y":0.08122919057429989},{"x":6.345993358793589,"y":0.10479568413597949},{"x":8.340350299379121,"y":0.0601697707957777},{"x":10.334707239964654,"y":0.05665986749935733},{"x":12.329064180550187,"y":0.016546686968838865},{"x":14.32342112113572,"y":0.0},{"x":16.317778061721253,"y":0.008022636106103693},{"x":18.312135002306785,"y":0.0},{"x":20.30649194289232,"y":0.0060169770795777695},{"x":22.30084888347785,"y":0.0},{"x":24.295205824063384,"y":0.0},{"x":26.289562764648917,"y":0.0},{"x":28.28391970523445,"y":0.0},{"x":30.278276645819982,"y":0.0},{"x":32.27263358640552,"y":0.0},{"x":34.26699052699105,"y":0.0},{"x":36.261347467576584,"y":0.0},{"x":38.25570440816212,"y":0.0},{"x":40.25006134874765,"y":0.0},{"x":42.24441828933318,"y":0.0},{"x":44.238775229918716,"y":0.0},{"x":46.23313217050425,"y":0.0},{"x":48.22748911108978,"y":0.0},{"x":50.221846051675314,"y":0.0},{"x":52.21620299226085,"y":0.0},{"x":54.21055993284638,"y":0.0},{"x":56.20491687343191,"y":0.0},{"x":58.199273814017445,"y":0.0},{"x":60.19363075460298,"y":0.0},{"x":62.18798769518851,"y":0.0},{"x":64.18234463577404,"y":0.0},{"x":66.17670157635958,"y":0.0},{"x":68.17105851694511,"y":0.0},{"x":70.16541545753064,"y":0.0},{"x":72.15977239811617,"y":0.0},{"x":74.15412933870171,"y":0.0},{"x":76.14848627928724,"y":0.0},{"x":78.14284321987277,"y":0.0},{"x":80.1372001604583,"y":0.0},{"x":82.13155710104384,"y":0.0},{"x":84.12591404162937,"y":0.0},{"x":86.1202709822149,"y":0.0},{"x":88.11462792280044,"y":0.0},{"x":90.10898486338597,"y":0.0},{"x":92.1033418039715,"y":0.0},{"x":94.09769874455704,"y":0.0},{"x":96.09205568514257,"y":0.0},{"x":98.0864126257281,"y":0.0},{"x":100.08076956631363,"y":0.0},{"x":102.07512650689917,"y":0.0},{"x":104.0694834474847,"y":0.0},{"x":106.06384038807023,"y":0.0},{"x":108.05819732865577,"y":0.0},{"x":110.0525542692413,"y":0.0},{"x":112.04691120982683,"y":0.0},{"x":114.04126815041236,"y":0.0},{"x":116.0356250909979,"y":0.0},{"x":118.02998203158343,"y":0.0},{"x":120.02433897216896,"y":0.0},{"x":122.0186959127545,"y":0.0},{"x":124.01305285334003,"y":0.0},{"x":126.00740979392556,"y":0.0},{"x":128.0017667345111,"y":0.0},{"x":129.99612367509664,"y":0.0},{"x":131.99048061568217,"y":0.0},{"x":133.9848375562677,"y":0.0},{"x":135.97919449685324,"y":0.0},{"x":137.97355143743877,"y":0.0},{"x":139.9679083780243,"y":0.0},{"x":141.96226531860984,"y":0.0},{"x":143.95662225919537,"y":0.0},{"x":145.9509791997809,"y":0.0},{"x":147.94533614036644,"y":0.0},{"x":149.93969308095197,"y":0.0},{"x":151.9340500215375,"y":0.0},{"x":153.92840696212303,"y":0.0},{"x":155.92276390270857,"y":0.0},{"x":157.9171208432941,"y":0.0},{"x":159.91147778387963,"y":0.0},{"x":161.90583472446517,"y":0.0},{"x":163.9001916650507,"y":0.0},{"x":165.89454860563623,"y":0.0},{"x":167.88890554622176,"y":0.0},{"x":169.8832624868073,"y":0.0},{"x":171.87761942739283,"y":0.0},{"x":173.87197636797836,"y":0.0},{"x":175.8663333085639,"y":0.0},{"x":177.86069024914943,"y":0.0},{"x":179.85504718973496,"y":0.0},{"x":181.8494041303205,"y":0.0},{"x":183.84376107090603,"y":0.007019806592840731},{"x":185.83811801149156,"y":0}]}],"marks":[{"type":"line","from":{"data":"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3\", :values ({:x -17.586289928232812, :y 0} {:x -15.59193298764728, :y 0.0030084885397888847} {:x -13.597576047061747, :y 0.0060169770795777695} {:x -11.603219106476214, :y 0.0} {:x -9.608862165890681, :y 0.0030084885397888847} {:x -7.614505225305147, :y 0.004011318053051847} {:x -5.620148284719614, :y 0.02005659026525923} {:x -3.62579134413408, :y 0.009025465619366655} {:x -1.6314344035485462, :y 0.03158912966778329} {:x 0.3629225370369875, :y 0.028580641127994407} {:x 2.357279477622521, :y 0.055657037986094365} {:x 4.351636418208055, :y 0.08122919057429989} {:x 6.345993358793589, :y 0.10479568413597949} {:x 8.340350299379121, :y 0.0601697707957777} {:x 10.334707239964654, :y 0.05665986749935733} {:x 12.329064180550187, :y 0.016546686968838865} {:x 14.32342112113572, :y 0.0} {:x 16.317778061721253, :y 0.008022636106103693} {:x 18.312135002306785, :y 0.0} {:x 20.30649194289232, :y 0.0060169770795777695} {:x 22.30084888347785, :y 0.0} {:x 24.295205824063384, :y 0.0} {:x 26.289562764648917, :y 0.0} {:x 28.28391970523445, :y 0.0} {:x 30.278276645819982, :y 0.0} {:x 32.27263358640552, :y 0.0} {:x 34.26699052699105, :y 0.0} {:x 36.261347467576584, :y 0.0} {:x 38.25570440816212, :y 0.0} {:x 40.25006134874765, :y 0.0} {:x 42.24441828933318, :y 0.0} {:x 44.238775229918716, :y 0.0} {:x 46.23313217050425, :y 0.0} {:x 48.22748911108978, :y 0.0} {:x 50.221846051675314, :y 0.0} {:x 52.21620299226085, :y 0.0} {:x 54.21055993284638, :y 0.0} {:x 56.20491687343191, :y 0.0} {:x 58.199273814017445, :y 0.0} {:x 60.19363075460298, :y 0.0} {:x 62.18798769518851, :y 0.0} {:x 64.18234463577404, :y 0.0} {:x 66.17670157635958, :y 0.0} {:x 68.17105851694511, :y 0.0} {:x 70.16541545753064, :y 0.0} {:x 72.15977239811617, :y 0.0} {:x 74.15412933870171, :y 0.0} {:x 76.14848627928724, :y 0.0} {:x 78.14284321987277, :y 0.0} {:x 80.1372001604583, :y 0.0} {:x 82.13155710104384, :y 0.0} {:x 84.12591404162937, :y 0.0} {:x 86.1202709822149, :y 0.0} {:x 88.11462792280044, :y 0.0} {:x 90.10898486338597, :y 0.0} {:x 92.1033418039715, :y 0.0} {:x 94.09769874455704, :y 0.0} {:x 96.09205568514257, :y 0.0} {:x 98.0864126257281, :y 0.0} {:x 100.08076956631363, :y 0.0} {:x 102.07512650689917, :y 0.0} {:x 104.0694834474847, :y 0.0} {:x 106.06384038807023, :y 0.0} {:x 108.05819732865577, :y 0.0} {:x 110.0525542692413, :y 0.0} {:x 112.04691120982683, :y 0.0} {:x 114.04126815041236, :y 0.0} {:x 116.0356250909979, :y 0.0} {:x 118.02998203158343, :y 0.0} {:x 120.02433897216896, :y 0.0} {:x 122.0186959127545, :y 0.0} {:x 124.01305285334003, :y 0.0} {:x 126.00740979392556, :y 0.0} {:x 128.0017667345111, :y 0.0} {:x 129.99612367509664, :y 0.0} {:x 131.99048061568217, :y 0.0} {:x 133.9848375562677, :y 0.0} {:x 135.97919449685324, :y 0.0} {:x 137.97355143743877, :y 0.0} {:x 139.9679083780243, :y 0.0} {:x 141.96226531860984, :y 0.0} {:x 143.95662225919537, :y 0.0} {:x 145.9509791997809, :y 0.0} {:x 147.94533614036644, :y 0.0} {:x 149.93969308095197, :y 0.0} {:x 151.9340500215375, :y 0.0} {:x 153.92840696212303, :y 0.0} {:x 155.92276390270857, :y 0.0} {:x 157.9171208432941, :y 0.0} {:x 159.91147778387963, :y 0.0} {:x 161.90583472446517, :y 0.0} {:x 163.9001916650507, :y 0.0} {:x 165.89454860563623, :y 0.0} {:x 167.88890554622176, :y 0.0} {:x 169.8832624868073, :y 0.0} {:x 171.87761942739283, :y 0.0} {:x 173.87197636797836, :y 0.0} {:x 175.8663333085639, :y 0.0} {:x 177.86069024914943, :y 0.0} {:x 179.85504718973496, :y 0.0} {:x 181.8494041303205, :y 0.0} {:x 183.84376107090603, :y 0.007019806592840731} {:x 185.83811801149156, :y 0})}], :marks [{:type \"line\", :from {:data \"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"ae0d9164-ad3b-4b5b-a5ee-6d32c724eff3\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@

;; @@
