;; gorilla-repl.fileformat = 1

;; **
;;; # Dirichlet Process Mixture Model - stick breaking construction
;; **

;; @@
(ns worksheets.dirichlet-process-mixture-stick-breaking
  (:require [anglican.runtime :refer :all]
            [anglican.emit :refer [defquery with-primitive-procedures defm]]
            [anglican.stat :refer [empirical-distribution collect-predicts collect-by collect-results]]
            [anglican.core :refer [doquery]]
            [anglican.state :refer [get-predicts]]
            anglican.infcomp.csis
            anglican.importance
            anglican.smc
            anglican.pgibbs
            anglican.infcomp.core
            [anglican.infcomp.dists :refer :all]
            [anglican.infcomp.network :refer :all]
            [anglican.infcomp.prior :refer :all]
            [anglican.inference :refer [infer]]
            [helpers.gmm :refer [normalize move-to-unit-box gridify]]
            [gorilla-plot.core :as plot]))

(anglican.infcomp.core/reset-infcomp-addressing-scheme!)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#function[anglican.infcomp.core/reset-infcomp-addressing-scheme!$fn--27378$fn--27379]</span>","value":"#function[anglican.infcomp.core/reset-infcomp-addressing-scheme!$fn--27378$fn--27379]"}
;; <=

;; @@
(defm create-sethuraman-stick-breaking-process
  [concentration]
  (let
    [
      ; sethuraman-stick-breaking-rule returns 
      ; a stick length via the one-parameter 
      ; stick breaking rule which closes
      ; over concentration
      sethuraman-stick-breaking-rule 
      (mem (fn [k] (sample* (beta 1 concentration))))

      ; sample-stick-index is a procedure that 
      ; samples an index from a potentially 
      ; infinite dimensional discrete distribution 
      ; lazily constructed by a stick breaking rule
      sample-stick-index 
      (fn sample-stick-index [k] 
        (if (sample* (flip (sethuraman-stick-breaking-rule k))) 
          k 
          (sample-stick-index (+ k 1))))

      ; wrapping a stick breaking process to return it
      stick-breaking-process 
      (fn [] (sample-stick-index 1))]
    stick-breaking-process))

(defm DPmem
  "DPmem is a procedure that takes two arguments -- 
  the concentration to a Dirichlet process
  and a base sampling procedure. DPmem returns a procedure."
  [concentration base]
  (let [get-value-from-cache-or-sample 
        (mem 
          (fn [args stick-index] 
            (apply base args)))
        get-stick-picking-procedure-from-cache 
        (mem 
          (fn [args] 
            (create-sethuraman-stick-breaking-process 
              concentration)))]
    (fn [& varargs]
      ; when the returned function is called, 
      ; the first thing it does is get
      ; the cached stick breaking procedure 
      ; for the passed in arguments
      ; and _calls_ it to get an index
      (let [index ((get-stick-picking-procedure-from-cache 
                     varargs))]
        ; if, for the given set of arguments 
        ; and just sampled index a return value has already 
        ; been computed, get it from the cache
        ; and return it, otherwise sample a new value
        (get-value-from-cache-or-sample varargs index)))))

(defquery dirichlet-process-mixture-stick-breaking
  [input-data]
  (let
    [concentration 1.72
     base (fn []
            (let [v (/ 1.0 (sample (gamma 1 10)))]
              (list (sample (normal 0 (sqrt (* v 10)))) 
                    (sqrt v))))
     obs-param (DPmem concentration base)]

    ; observe draws from the DP mixture
    (map
      (fn [value]
        (observe (apply normal (obs-param)) value))
      input-data)

    ; predict a data point from the DP mixture
    (sample (apply normal (obs-param)))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/dirichlet-process-mixture-stick-breaking</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/dirichlet-process-mixture-stick-breaking"}
;; <=

;; **
;;; ## Inference compilation
;;; 
;;; Specify a function `combine-observes-fn` that combines observes from a sample in a form suitable for Torch:
;; **

;; @@
(sample-samples-from-prior dirichlet-process-mixture-stick-breaking [(repeat 8 nil)])
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:time-index 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x1a369324 &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@1a369324&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x1a369324 \"anglican.infcomp.flatbuffers.gamma.GammaClj@1a369324\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x1a369324 \"anglican.infcomp.flatbuffers.gamma.GammaClj@1a369324\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.06282911922751212</span>","value":"0.06282911922751212"}],"value":"[:value 0.06282911922751212]"}],"value":"{:time-index 0, :sample-address \"S65\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x1a369324 \"anglican.infcomp.flatbuffers.gamma.GammaClj@1a369324\"], :value 0.06282911922751212}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:time-index 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x668a73a0 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@668a73a0&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x668a73a0 \"anglican.infcomp.flatbuffers.normal.NormalClj@668a73a0\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x668a73a0 \"anglican.infcomp.flatbuffers.normal.NormalClj@668a73a0\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-4.229555162637349</span>","value":"-4.229555162637349"}],"value":"[:value -4.229555162637349]"}],"value":"{:time-index 1, :sample-address \"S61\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x668a73a0 \"anglican.infcomp.flatbuffers.normal.NormalClj@668a73a0\"], :value -4.229555162637349}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:time-index 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:sample-instance 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x6ba6d76 &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@6ba6d76&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x6ba6d76 \"anglican.infcomp.flatbuffers.gamma.GammaClj@6ba6d76\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x6ba6d76 \"anglican.infcomp.flatbuffers.gamma.GammaClj@6ba6d76\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.17274400653355815</span>","value":"0.17274400653355815"}],"value":"[:value 0.17274400653355815]"}],"value":"{:time-index 2, :sample-address \"S65\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x6ba6d76 \"anglican.infcomp.flatbuffers.gamma.GammaClj@6ba6d76\"], :value 0.17274400653355815}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>3</span>","value":"3"}],"value":"[:time-index 3]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:sample-instance 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x4b1e7681 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@4b1e7681&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x4b1e7681 \"anglican.infcomp.flatbuffers.normal.NormalClj@4b1e7681\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x4b1e7681 \"anglican.infcomp.flatbuffers.normal.NormalClj@4b1e7681\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-11.564966263460976</span>","value":"-11.564966263460976"}],"value":"[:value -11.564966263460976]"}],"value":"{:time-index 3, :sample-address \"S61\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x4b1e7681 \"anglican.infcomp.flatbuffers.normal.NormalClj@4b1e7681\"], :value -11.564966263460976}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>4</span>","value":"4"}],"value":"[:time-index 4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S46&quot;</span>","value":"\"S46\""}],"value":"[:sample-address \"S46\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x659f7375 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@659f7375&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x659f7375 \"anglican.infcomp.flatbuffers.normal.NormalClj@659f7375\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x659f7375 \"anglican.infcomp.flatbuffers.normal.NormalClj@659f7375\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-4.9282610379498895</span>","value":"-4.9282610379498895"}],"value":"[:value -4.9282610379498895]"}],"value":"{:time-index 4, :sample-address \"S46\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x659f7375 \"anglican.infcomp.flatbuffers.normal.NormalClj@659f7375\"], :value -4.9282610379498895}"}],"value":"[{:time-index 0, :sample-address \"S65\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x1a369324 \"anglican.infcomp.flatbuffers.gamma.GammaClj@1a369324\"], :value 0.06282911922751212} {:time-index 1, :sample-address \"S61\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x668a73a0 \"anglican.infcomp.flatbuffers.normal.NormalClj@668a73a0\"], :value -4.229555162637349} {:time-index 2, :sample-address \"S65\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x6ba6d76 \"anglican.infcomp.flatbuffers.gamma.GammaClj@6ba6d76\"], :value 0.17274400653355815} {:time-index 3, :sample-address \"S61\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x4b1e7681 \"anglican.infcomp.flatbuffers.normal.NormalClj@4b1e7681\"], :value -11.564966263460976} {:time-index 4, :sample-address \"S46\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x659f7375 \"anglican.infcomp.flatbuffers.normal.NormalClj@659f7375\"], :value -4.9282610379498895}]"}
;; <=

;; @@
(defn combine-observes-fn [observes]
  (gridify (move-to-unit-box (map #(/ (:value %) 50) observes)) [30]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/combine-observes-fn</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/combine-observes-fn"}
;; <=

;; @@
(plot/list-plot (combine-observes-fn (sample-observes-from-prior dirichlet-process-mixture-stick-breaking [(repeat 8 nil)])))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"f62353c7-9fa6-4749-a465-57d7e9a663df","values":[{"x":0,"y":0.0},{"x":1,"y":0.0},{"x":2,"y":0.0},{"x":3,"y":0.0},{"x":4,"y":0.0},{"x":5,"y":0.0},{"x":6,"y":0.0},{"x":7,"y":0.0},{"x":8,"y":0.0},{"x":9,"y":0.0},{"x":10,"y":0.0},{"x":11,"y":0.0},{"x":12,"y":0.0},{"x":13,"y":0.5},{"x":14,"y":0.0},{"x":15,"y":0.0},{"x":16,"y":1.0},{"x":17,"y":0.5},{"x":18,"y":0.0},{"x":19,"y":1.0},{"x":20,"y":0.0},{"x":21,"y":0.5},{"x":22,"y":0.0},{"x":23,"y":0.0},{"x":24,"y":0.0},{"x":25,"y":0.0},{"x":26,"y":0.0},{"x":27,"y":0.0},{"x":28,"y":0.0},{"x":29,"y":0.0}]}],"marks":[{"type":"symbol","from":{"data":"f62353c7-9fa6-4749-a465-57d7e9a663df"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"f62353c7-9fa6-4749-a465-57d7e9a663df","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"f62353c7-9fa6-4749-a465-57d7e9a663df","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"f62353c7-9fa6-4749-a465-57d7e9a663df\", :values ({:x 0, :y 0.0} {:x 1, :y 0.0} {:x 2, :y 0.0} {:x 3, :y 0.0} {:x 4, :y 0.0} {:x 5, :y 0.0} {:x 6, :y 0.0} {:x 7, :y 0.0} {:x 8, :y 0.0} {:x 9, :y 0.0} {:x 10, :y 0.0} {:x 11, :y 0.0} {:x 12, :y 0.0} {:x 13, :y 0.5} {:x 14, :y 0.0} {:x 15, :y 0.0} {:x 16, :y 1.0} {:x 17, :y 0.5} {:x 18, :y 0.0} {:x 19, :y 1.0} {:x 20, :y 0.0} {:x 21, :y 0.5} {:x 22, :y 0.0} {:x 23, :y 0.0} {:x 24, :y 0.0} {:x 25, :y 0.0} {:x 26, :y 0.0} {:x 27, :y 0.0} {:x 28, :y 0.0} {:x 29, :y 0.0})}], :marks [{:type \"symbol\", :from {:data \"f62353c7-9fa6-4749-a465-57d7e9a663df\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"f62353c7-9fa6-4749-a465-57d7e9a663df\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"f62353c7-9fa6-4749-a465-57d7e9a663df\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(def torch-connection (start-torch-connection dirichlet-process-mixture-stick-breaking [(repeat 8 nil)] combine-observes-fn))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/torch-connection</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/torch-connection"}
;; <=

;; @@
(stop-torch-connection torch-connection)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-string'>&quot;Torch connection terminated.&quot;</span>","value":"\"Torch connection terminated.\""}
;; <=

;; **
;;; ## Inference
;; **

;; @@
(def test-observations
  [-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
   7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
   3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3])

(def test-observations
  [-4 -4 -4 -4 4 4 4 4])

(def test-observations
  [1.45 1 0.9 2.5 17.8 18.2 17.9 17.8])
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/test-observations</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/test-observations"}
;; <=

;; **
;;; ### Infcomp
;;; 
;;; First, run the inference server from torch-infcomp:
;;; 
;;; `python -m infcomp.infer`
;;; 
;;; Then run the query, specifying number of particles:
;; **

;; @@
(def num-particles 1000)
(def csis-states (take num-particles (infer :csis dirichlet-process-mixture-stick-breaking [test-observations]
                                            :observe-embedder-input (gridify (move-to-unit-box (map #(/ % 50) test-observations)) [30]))))
(plot/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results csis-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"ddf80ee3-de48-4c4d-895d-3d9640f1a671","values":[{"x":-22.790228809622327,"y":0},{"x":-21.933370992509367,"y":0.029176369171997972},{"x":-21.076513175396407,"y":0.0},{"x":-20.219655358283447,"y":0.0},{"x":-19.362797541170487,"y":0.0070023286012795135},{"x":-18.505939724057527,"y":0.0},{"x":-17.649081906944566,"y":0.0},{"x":-16.792224089831606,"y":0.0},{"x":-15.935366272718648,"y":0.12720896958991115},{"x":-15.07850845560569,"y":0.0},{"x":-14.221650638492731,"y":0.0},{"x":-13.364792821379773,"y":0.0},{"x":-12.507935004266814,"y":0.002334109533759838},{"x":-11.651077187153856,"y":0.0},{"x":-10.794219370040897,"y":0.0},{"x":-9.937361552927939,"y":0.0},{"x":-9.08050373581498,"y":0.0},{"x":-8.223645918702022,"y":0.0},{"x":-7.366788101589064,"y":0.0},{"x":-6.5099302844761056,"y":0.0},{"x":-5.653072467363147,"y":0.0},{"x":-4.796214650250189,"y":0.001167054766879919},{"x":-3.9393568331372304,"y":0.0},{"x":-3.082499016024272,"y":0.0},{"x":-2.2256411989113136,"y":0.0},{"x":-1.3687833817983552,"y":0.0},{"x":-0.5119255646853967,"y":0.019839931036958622},{"x":0.34493225242756176,"y":0.01050349290191927},{"x":1.2017900695405204,"y":0.0},{"x":2.0586478866534788,"y":0.029176369171997972},{"x":2.915505703766437,"y":0.0},{"x":3.7723635208793955,"y":0.0},{"x":4.629221337992354,"y":0.01167054766879919},{"x":5.486079155105313,"y":0.0},{"x":6.342936972218271,"y":0.1108702028535923},{"x":7.1997947893312295,"y":0.26492143208174157},{"x":8.056652606444189,"y":0.12137369575551157},{"x":8.913510423557147,"y":0.0},{"x":9.770368240670106,"y":0.0},{"x":10.627226057783064,"y":0.0035011643006397568},{"x":11.484083874896022,"y":0.03384458823951765},{"x":12.34094169200898,"y":0.029176369171997972},{"x":13.197799509121939,"y":0.08869616228287384},{"x":14.054657326234897,"y":0.0},{"x":14.911515143347856,"y":0.07585855984719472},{"x":15.768372960460814,"y":0.0},{"x":16.625230777573773,"y":0.10620198378607262},{"x":17.482088594686733,"y":0.0},{"x":18.338946411799693,"y":0.0},{"x":19.195804228912653,"y":0.0},{"x":20.052662046025613,"y":0.0},{"x":20.909519863138573,"y":0.001167054766879919},{"x":21.766377680251534,"y":0.0},{"x":22.623235497364494,"y":0.0},{"x":23.480093314477454,"y":0.0},{"x":24.336951131590414,"y":0.009336438135039352},{"x":25.193808948703374,"y":0.0},{"x":26.050666765816334,"y":0.0},{"x":26.907524582929295,"y":0.0},{"x":27.764382400042255,"y":0.0},{"x":28.621240217155215,"y":0.0},{"x":29.478098034268175,"y":0.0035011643006397568},{"x":30.334955851381135,"y":0.0},{"x":31.191813668494095,"y":0.0},{"x":32.04867148560705,"y":0.0},{"x":32.90552930272001,"y":0.0},{"x":33.76238711983297,"y":0.0},{"x":34.61924493694593,"y":0.0},{"x":35.47610275405889,"y":0.0},{"x":36.33296057117185,"y":0.0},{"x":37.18981838828481,"y":0.0},{"x":38.04667620539777,"y":0.0},{"x":38.90353402251073,"y":0.0},{"x":39.76039183962369,"y":0.0},{"x":40.617249656736654,"y":0.0},{"x":41.474107473849614,"y":0.0},{"x":42.330965290962574,"y":0.0},{"x":43.187823108075534,"y":0.0},{"x":44.044680925188494,"y":0.0},{"x":44.901538742301454,"y":0.001167054766879919},{"x":45.758396559414415,"y":0.0},{"x":46.615254376527375,"y":0.0},{"x":47.472112193640335,"y":0.0},{"x":48.328970010753295,"y":0.0},{"x":49.185827827866255,"y":0.0},{"x":50.042685644979215,"y":0.0},{"x":50.899543462092176,"y":0.0},{"x":51.756401279205136,"y":0.0},{"x":52.613259096318096,"y":0.0},{"x":53.470116913431056,"y":0.0},{"x":54.326974730544016,"y":0.0},{"x":55.183832547656976,"y":0.0},{"x":56.04069036476994,"y":0.0},{"x":56.8975481818829,"y":0.0},{"x":57.75440599899586,"y":0.0},{"x":58.61126381610882,"y":0.0},{"x":59.46812163322178,"y":0.0},{"x":60.32497945033474,"y":0.0},{"x":61.1818372674477,"y":0.0},{"x":62.03869508456066,"y":0.0},{"x":62.89555290167362,"y":0.07935972414783449},{"x":63.75241071878658,"y":0}]}],"marks":[{"type":"line","from":{"data":"ddf80ee3-de48-4c4d-895d-3d9640f1a671"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"ddf80ee3-de48-4c4d-895d-3d9640f1a671","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"ddf80ee3-de48-4c4d-895d-3d9640f1a671","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"ddf80ee3-de48-4c4d-895d-3d9640f1a671\", :values ({:x -22.790228809622327, :y 0} {:x -21.933370992509367, :y 0.029176369171997972} {:x -21.076513175396407, :y 0.0} {:x -20.219655358283447, :y 0.0} {:x -19.362797541170487, :y 0.0070023286012795135} {:x -18.505939724057527, :y 0.0} {:x -17.649081906944566, :y 0.0} {:x -16.792224089831606, :y 0.0} {:x -15.935366272718648, :y 0.12720896958991115} {:x -15.07850845560569, :y 0.0} {:x -14.221650638492731, :y 0.0} {:x -13.364792821379773, :y 0.0} {:x -12.507935004266814, :y 0.002334109533759838} {:x -11.651077187153856, :y 0.0} {:x -10.794219370040897, :y 0.0} {:x -9.937361552927939, :y 0.0} {:x -9.08050373581498, :y 0.0} {:x -8.223645918702022, :y 0.0} {:x -7.366788101589064, :y 0.0} {:x -6.5099302844761056, :y 0.0} {:x -5.653072467363147, :y 0.0} {:x -4.796214650250189, :y 0.001167054766879919} {:x -3.9393568331372304, :y 0.0} {:x -3.082499016024272, :y 0.0} {:x -2.2256411989113136, :y 0.0} {:x -1.3687833817983552, :y 0.0} {:x -0.5119255646853967, :y 0.019839931036958622} {:x 0.34493225242756176, :y 0.01050349290191927} {:x 1.2017900695405204, :y 0.0} {:x 2.0586478866534788, :y 0.029176369171997972} {:x 2.915505703766437, :y 0.0} {:x 3.7723635208793955, :y 0.0} {:x 4.629221337992354, :y 0.01167054766879919} {:x 5.486079155105313, :y 0.0} {:x 6.342936972218271, :y 0.1108702028535923} {:x 7.1997947893312295, :y 0.26492143208174157} {:x 8.056652606444189, :y 0.12137369575551157} {:x 8.913510423557147, :y 0.0} {:x 9.770368240670106, :y 0.0} {:x 10.627226057783064, :y 0.0035011643006397568} {:x 11.484083874896022, :y 0.03384458823951765} {:x 12.34094169200898, :y 0.029176369171997972} {:x 13.197799509121939, :y 0.08869616228287384} {:x 14.054657326234897, :y 0.0} {:x 14.911515143347856, :y 0.07585855984719472} {:x 15.768372960460814, :y 0.0} {:x 16.625230777573773, :y 0.10620198378607262} {:x 17.482088594686733, :y 0.0} {:x 18.338946411799693, :y 0.0} {:x 19.195804228912653, :y 0.0} {:x 20.052662046025613, :y 0.0} {:x 20.909519863138573, :y 0.001167054766879919} {:x 21.766377680251534, :y 0.0} {:x 22.623235497364494, :y 0.0} {:x 23.480093314477454, :y 0.0} {:x 24.336951131590414, :y 0.009336438135039352} {:x 25.193808948703374, :y 0.0} {:x 26.050666765816334, :y 0.0} {:x 26.907524582929295, :y 0.0} {:x 27.764382400042255, :y 0.0} {:x 28.621240217155215, :y 0.0} {:x 29.478098034268175, :y 0.0035011643006397568} {:x 30.334955851381135, :y 0.0} {:x 31.191813668494095, :y 0.0} {:x 32.04867148560705, :y 0.0} {:x 32.90552930272001, :y 0.0} {:x 33.76238711983297, :y 0.0} {:x 34.61924493694593, :y 0.0} {:x 35.47610275405889, :y 0.0} {:x 36.33296057117185, :y 0.0} {:x 37.18981838828481, :y 0.0} {:x 38.04667620539777, :y 0.0} {:x 38.90353402251073, :y 0.0} {:x 39.76039183962369, :y 0.0} {:x 40.617249656736654, :y 0.0} {:x 41.474107473849614, :y 0.0} {:x 42.330965290962574, :y 0.0} {:x 43.187823108075534, :y 0.0} {:x 44.044680925188494, :y 0.0} {:x 44.901538742301454, :y 0.001167054766879919} {:x 45.758396559414415, :y 0.0} {:x 46.615254376527375, :y 0.0} {:x 47.472112193640335, :y 0.0} {:x 48.328970010753295, :y 0.0} {:x 49.185827827866255, :y 0.0} {:x 50.042685644979215, :y 0.0} {:x 50.899543462092176, :y 0.0} {:x 51.756401279205136, :y 0.0} {:x 52.613259096318096, :y 0.0} {:x 53.470116913431056, :y 0.0} {:x 54.326974730544016, :y 0.0} {:x 55.183832547656976, :y 0.0} {:x 56.04069036476994, :y 0.0} {:x 56.8975481818829, :y 0.0} {:x 57.75440599899586, :y 0.0} {:x 58.61126381610882, :y 0.0} {:x 59.46812163322178, :y 0.0} {:x 60.32497945033474, :y 0.0} {:x 61.1818372674477, :y 0.0} {:x 62.03869508456066, :y 0.0} {:x 62.89555290167362, :y 0.07935972414783449} {:x 63.75241071878658, :y 0})}], :marks [{:type \"line\", :from {:data \"ddf80ee3-de48-4c4d-895d-3d9640f1a671\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"ddf80ee3-de48-4c4d-895d-3d9640f1a671\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"ddf80ee3-de48-4c4d-895d-3d9640f1a671\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; **
;;; ### IS
;; **

;; @@
(def num-particles 10000)
(def is-states (take num-particles (infer :importance dirichlet-process-mixture-stick-breaking [test-observations])))
(plot/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results is-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"de1b25c3-74b4-4e25-ba18-bea77bedda1a","values":[{"x":-29.080964191558536,"y":0},{"x":-28.18373997179151,"y":0.45696492690139534},{"x":-27.286515752024485,"y":0.0},{"x":-26.38929153225746,"y":0.0},{"x":-25.492067312490434,"y":0.0},{"x":-24.59484309272341,"y":0.0},{"x":-23.697618872956383,"y":0.0011145486021985251},{"x":-22.800394653189358,"y":0.0033436458065955756},{"x":-21.903170433422332,"y":0.0},{"x":-21.005946213655307,"y":0.0},{"x":-20.10872199388828,"y":0.0},{"x":-19.211497774121256,"y":0.0022290972043970503},{"x":-18.31427355435423,"y":0.0},{"x":-17.417049334587205,"y":0.0},{"x":-16.51982511482018,"y":0.0},{"x":-15.622600895053154,"y":0.0},{"x":-14.725376675286128,"y":0.0},{"x":-13.828152455519103,"y":0.0033436458065955756},{"x":-12.930928235752077,"y":0.0011145486021985251},{"x":-12.033704015985052,"y":0.0},{"x":-11.136479796218026,"y":0.0},{"x":-10.239255576451,"y":0.005572743010992626},{"x":-9.342031356683975,"y":0.0033436458065955756},{"x":-8.44480713691695,"y":0.02786371505496313},{"x":-7.547582917149925,"y":0.0011145486021985251},{"x":-6.6503586973829005,"y":0.0},{"x":-5.753134477615876,"y":0.0033436458065955756},{"x":-4.855910257848851,"y":0.020061874839573453},{"x":-3.9586860380818263,"y":0.0011145486021985251},{"x":-3.0614618183148012,"y":0.0044581944087941005},{"x":-2.164237598547776,"y":0.0033436458065955756},{"x":-1.2670133787807512,"y":0.0},{"x":-0.3697891590137262,"y":0.020061874839573453},{"x":0.5274350607532987,"y":0.022290972043970503},{"x":1.4246592805203235,"y":0.013374583226382302},{"x":2.3218835002873486,"y":0.010030937419786726},{"x":3.2191077200543736,"y":0.024520069248367554},{"x":4.116331939821398,"y":0.024520069248367554},{"x":5.013556159588423,"y":0.03343645806595576},{"x":5.910780379355447,"y":0.04346739548574248},{"x":6.808004599122472,"y":0.04235284688354396},{"x":7.705228818889497,"y":0.15715135290999205},{"x":8.602453038656522,"y":0.035665555270352804},{"x":9.499677258423548,"y":0.031207360861558706},{"x":10.396901478190573,"y":0.031207360861558706},{"x":11.294125697957599,"y":0.050154687098933635},{"x":12.191349917724624,"y":0.012260034624183777},{"x":13.08857413749165,"y":0.011145486021985252},{"x":13.985798357258675,"y":0.0022290972043970503},{"x":14.8830225770257,"y":0.0},{"x":15.780246796792726,"y":0.005572743010992626},{"x":16.67747101655975,"y":0.0},{"x":17.574695236326775,"y":0.0},{"x":18.4719194560938,"y":0.0},{"x":19.369143675860826,"y":0.0},{"x":20.26636789562785,"y":0.0011145486021985251},{"x":21.163592115394877,"y":0.0},{"x":22.060816335161903,"y":0.0},{"x":22.958040554928928,"y":0.0},{"x":23.855264774695954,"y":0.0},{"x":24.75248899446298,"y":0.0022290972043970503},{"x":25.649713214230005,"y":0.0},{"x":26.54693743399703,"y":0.0},{"x":27.444161653764056,"y":0.0},{"x":28.34138587353108,"y":0.0},{"x":29.238610093298107,"y":0.0},{"x":30.135834313065132,"y":0.0},{"x":31.033058532832158,"y":0.0},{"x":31.930282752599183,"y":0.0},{"x":32.82750697236621,"y":0.0},{"x":33.724731192133234,"y":0.0},{"x":34.62195541190026,"y":0.0},{"x":35.519179631667285,"y":0.0},{"x":36.41640385143431,"y":0.0},{"x":37.313628071201336,"y":0.0},{"x":38.21085229096836,"y":0.0},{"x":39.10807651073539,"y":0.0},{"x":40.00530073050241,"y":0.0},{"x":40.90252495026944,"y":0.0},{"x":41.79974917003646,"y":0.0},{"x":42.69697338980349,"y":0.0},{"x":43.594197609570514,"y":0.0},{"x":44.49142182933754,"y":0.0},{"x":45.388646049104565,"y":0.0},{"x":46.28587026887159,"y":0.0},{"x":47.183094488638616,"y":0.0},{"x":48.08031870840564,"y":0.0},{"x":48.97754292817267,"y":0.0},{"x":49.87476714793969,"y":0.0},{"x":50.77199136770672,"y":0.0},{"x":51.669215587473744,"y":0.0},{"x":52.56643980724077,"y":0.0},{"x":53.463664027007795,"y":0.0},{"x":54.36088824677482,"y":0.0},{"x":55.258112466541846,"y":0.0},{"x":56.15533668630887,"y":0.0},{"x":57.0525609060759,"y":0.0},{"x":57.94978512584292,"y":0.0},{"x":58.84700934560995,"y":0.0},{"x":59.74423356537697,"y":0.0},{"x":60.641457785144,"y":0.0022290972043970503},{"x":61.538682004911024,"y":0}]}],"marks":[{"type":"line","from":{"data":"de1b25c3-74b4-4e25-ba18-bea77bedda1a"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"de1b25c3-74b4-4e25-ba18-bea77bedda1a","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"de1b25c3-74b4-4e25-ba18-bea77bedda1a","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"de1b25c3-74b4-4e25-ba18-bea77bedda1a\", :values ({:x -29.080964191558536, :y 0} {:x -28.18373997179151, :y 0.45696492690139534} {:x -27.286515752024485, :y 0.0} {:x -26.38929153225746, :y 0.0} {:x -25.492067312490434, :y 0.0} {:x -24.59484309272341, :y 0.0} {:x -23.697618872956383, :y 0.0011145486021985251} {:x -22.800394653189358, :y 0.0033436458065955756} {:x -21.903170433422332, :y 0.0} {:x -21.005946213655307, :y 0.0} {:x -20.10872199388828, :y 0.0} {:x -19.211497774121256, :y 0.0022290972043970503} {:x -18.31427355435423, :y 0.0} {:x -17.417049334587205, :y 0.0} {:x -16.51982511482018, :y 0.0} {:x -15.622600895053154, :y 0.0} {:x -14.725376675286128, :y 0.0} {:x -13.828152455519103, :y 0.0033436458065955756} {:x -12.930928235752077, :y 0.0011145486021985251} {:x -12.033704015985052, :y 0.0} {:x -11.136479796218026, :y 0.0} {:x -10.239255576451, :y 0.005572743010992626} {:x -9.342031356683975, :y 0.0033436458065955756} {:x -8.44480713691695, :y 0.02786371505496313} {:x -7.547582917149925, :y 0.0011145486021985251} {:x -6.6503586973829005, :y 0.0} {:x -5.753134477615876, :y 0.0033436458065955756} {:x -4.855910257848851, :y 0.020061874839573453} {:x -3.9586860380818263, :y 0.0011145486021985251} {:x -3.0614618183148012, :y 0.0044581944087941005} {:x -2.164237598547776, :y 0.0033436458065955756} {:x -1.2670133787807512, :y 0.0} {:x -0.3697891590137262, :y 0.020061874839573453} {:x 0.5274350607532987, :y 0.022290972043970503} {:x 1.4246592805203235, :y 0.013374583226382302} {:x 2.3218835002873486, :y 0.010030937419786726} {:x 3.2191077200543736, :y 0.024520069248367554} {:x 4.116331939821398, :y 0.024520069248367554} {:x 5.013556159588423, :y 0.03343645806595576} {:x 5.910780379355447, :y 0.04346739548574248} {:x 6.808004599122472, :y 0.04235284688354396} {:x 7.705228818889497, :y 0.15715135290999205} {:x 8.602453038656522, :y 0.035665555270352804} {:x 9.499677258423548, :y 0.031207360861558706} {:x 10.396901478190573, :y 0.031207360861558706} {:x 11.294125697957599, :y 0.050154687098933635} {:x 12.191349917724624, :y 0.012260034624183777} {:x 13.08857413749165, :y 0.011145486021985252} {:x 13.985798357258675, :y 0.0022290972043970503} {:x 14.8830225770257, :y 0.0} {:x 15.780246796792726, :y 0.005572743010992626} {:x 16.67747101655975, :y 0.0} {:x 17.574695236326775, :y 0.0} {:x 18.4719194560938, :y 0.0} {:x 19.369143675860826, :y 0.0} {:x 20.26636789562785, :y 0.0011145486021985251} {:x 21.163592115394877, :y 0.0} {:x 22.060816335161903, :y 0.0} {:x 22.958040554928928, :y 0.0} {:x 23.855264774695954, :y 0.0} {:x 24.75248899446298, :y 0.0022290972043970503} {:x 25.649713214230005, :y 0.0} {:x 26.54693743399703, :y 0.0} {:x 27.444161653764056, :y 0.0} {:x 28.34138587353108, :y 0.0} {:x 29.238610093298107, :y 0.0} {:x 30.135834313065132, :y 0.0} {:x 31.033058532832158, :y 0.0} {:x 31.930282752599183, :y 0.0} {:x 32.82750697236621, :y 0.0} {:x 33.724731192133234, :y 0.0} {:x 34.62195541190026, :y 0.0} {:x 35.519179631667285, :y 0.0} {:x 36.41640385143431, :y 0.0} {:x 37.313628071201336, :y 0.0} {:x 38.21085229096836, :y 0.0} {:x 39.10807651073539, :y 0.0} {:x 40.00530073050241, :y 0.0} {:x 40.90252495026944, :y 0.0} {:x 41.79974917003646, :y 0.0} {:x 42.69697338980349, :y 0.0} {:x 43.594197609570514, :y 0.0} {:x 44.49142182933754, :y 0.0} {:x 45.388646049104565, :y 0.0} {:x 46.28587026887159, :y 0.0} {:x 47.183094488638616, :y 0.0} {:x 48.08031870840564, :y 0.0} {:x 48.97754292817267, :y 0.0} {:x 49.87476714793969, :y 0.0} {:x 50.77199136770672, :y 0.0} {:x 51.669215587473744, :y 0.0} {:x 52.56643980724077, :y 0.0} {:x 53.463664027007795, :y 0.0} {:x 54.36088824677482, :y 0.0} {:x 55.258112466541846, :y 0.0} {:x 56.15533668630887, :y 0.0} {:x 57.0525609060759, :y 0.0} {:x 57.94978512584292, :y 0.0} {:x 58.84700934560995, :y 0.0} {:x 59.74423356537697, :y 0.0} {:x 60.641457785144, :y 0.0022290972043970503} {:x 61.538682004911024, :y 0})}], :marks [{:type \"line\", :from {:data \"de1b25c3-74b4-4e25-ba18-bea77bedda1a\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"de1b25c3-74b4-4e25-ba18-bea77bedda1a\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"de1b25c3-74b4-4e25-ba18-bea77bedda1a\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; **
;;; ### SMC
;; **

;; @@
(def num-particles 1000)
(def smc-states (take num-particles (infer :smc dirichlet-process-mixture-stick-breaking [test-observations] :number-of-particles 100)))
(plot/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results smc-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"c46f1608-7561-48ce-beba-9467a0b6481f","values":[{"x":-74.92139415587361,"y":0},{"x":-73.74520528823822,"y":8.502035918860538E-4},{"x":-72.56901642060284,"y":0.0},{"x":-71.39282755296745,"y":0.0},{"x":-70.21663868533206,"y":0.0},{"x":-69.04044981769667,"y":0.0},{"x":-67.86426095006128,"y":0.0},{"x":-66.68807208242589,"y":0.0},{"x":-65.5118832147905,"y":0.0},{"x":-64.33569434715511,"y":0.0},{"x":-63.15950547951972,"y":0.0},{"x":-61.983316611884334,"y":0.0},{"x":-60.807127744248945,"y":0.0},{"x":-59.630938876613556,"y":0.0},{"x":-58.454750008978166,"y":0.0},{"x":-57.27856114134278,"y":0.0},{"x":-56.10237227370739,"y":0.0},{"x":-54.926183406072,"y":0.0},{"x":-53.74999453843661,"y":0.0},{"x":-52.57380567080122,"y":0.0},{"x":-51.39761680316583,"y":0.0},{"x":-50.22142793553044,"y":0.0},{"x":-49.045239067895054,"y":0.0},{"x":-47.869050200259665,"y":0.0},{"x":-46.692861332624275,"y":0.0},{"x":-45.516672464988886,"y":0.0},{"x":-44.3404835973535,"y":0.0},{"x":-43.16429472971811,"y":0.0},{"x":-41.98810586208272,"y":0.0},{"x":-40.81191699444733,"y":0.0},{"x":-39.63572812681194,"y":0.0},{"x":-38.45953925917655,"y":0.0},{"x":-37.28335039154116,"y":0.0017004071837721077},{"x":-36.10716152390577,"y":0.0},{"x":-34.930972656270384,"y":0.007651832326974485},{"x":-33.754783788634995,"y":0.0},{"x":-32.578594920999606,"y":0.0},{"x":-31.402406053364214,"y":8.502035918860538E-4},{"x":-30.22621718572882,"y":0.0},{"x":-29.05002831809343,"y":0.0},{"x":-27.873839450458036,"y":0.0},{"x":-26.697650582822643,"y":0.0},{"x":-25.52146171518725,"y":0.0},{"x":-24.345272847551858,"y":0.0017004071837721077},{"x":-23.169083979916465,"y":0.0},{"x":-21.992895112281072,"y":0.0},{"x":-20.81670624464568,"y":8.502035918860538E-4},{"x":-19.640517377010287,"y":0.0017004071837721077},{"x":-18.464328509374894,"y":0.0025506107756581614},{"x":-17.2881396417395,"y":0.0},{"x":-16.11195077410411,"y":0.0017004071837721077},{"x":-14.935761906468718,"y":0.0},{"x":-13.759573038833327,"y":8.502035918860538E-4},{"x":-12.583384171197936,"y":8.502035918860538E-4},{"x":-11.407195303562546,"y":0.004251017959430269},{"x":-10.231006435927155,"y":0.0017004071837721077},{"x":-9.054817568291764,"y":0.0034008143675442154},{"x":-7.878628700656373,"y":0.005951425143202377},{"x":-6.702439833020982,"y":0.011902850286404754},{"x":-5.526250965385591,"y":0.0017004071837721077},{"x":-4.3500620977502,"y":0.004251017959430269},{"x":-3.173873230114809,"y":0.014453461062062915},{"x":-1.9976843624794176,"y":0.016153868245835024},{"x":-0.8214954948440263,"y":0.03230773649167005},{"x":0.35469337279136504,"y":0.0552632334725935},{"x":1.5308822404267564,"y":0.07056689812654247},{"x":2.7070711080621477,"y":0.06291506579956799},{"x":3.883259975697539,"y":0.04336038318618875},{"x":5.05944884333293,"y":0.0680162873508843},{"x":6.235637710968321,"y":0.0221052933890374},{"x":7.411826578603712,"y":0.014453461062062915},{"x":8.588015446239103,"y":0.005951425143202377},{"x":9.764204313874494,"y":0.025506107756581617},{"x":10.940393181509885,"y":0.028056718532239778},{"x":12.116582049145276,"y":0.03230773649167005},{"x":13.292770916780666,"y":0.03910936522675848},{"x":14.468959784416057,"y":0.016153868245835024},{"x":15.645148652051448,"y":0.038259161634872425},{"x":16.82133751968684,"y":0.034858347267328206},{"x":17.99752638732223,"y":0.0442105867780748},{"x":19.173715254957624,"y":0.0331579400835561},{"x":20.349904122593017,"y":0.024655904164695562},{"x":21.52609299022841,"y":0.029757125716011884},{"x":22.702281857863802,"y":0.0110526466945187},{"x":23.878470725499195,"y":0.008502035918860538},{"x":25.054659593134588,"y":0.009352239510746593},{"x":26.23084846076998,"y":0.004251017959430269},{"x":27.407037328405373,"y":0.004251017959430269},{"x":28.583226196040766,"y":0.0},{"x":29.75941506367616,"y":0.0},{"x":30.93560393131155,"y":0.0034008143675442154},{"x":32.111792798946944,"y":8.502035918860538E-4},{"x":33.28798166658233,"y":8.502035918860538E-4},{"x":34.46417053421772,"y":8.502035918860538E-4},{"x":35.64035940185311,"y":0.0},{"x":36.8165482694885,"y":0.0},{"x":37.99273713712389,"y":0.0},{"x":39.16892600475928,"y":0.0},{"x":40.34511487239467,"y":0.0},{"x":41.521303740030056,"y":0.0},{"x":42.697492607665446,"y":0.0},{"x":43.873681475300835,"y":8.502035918860538E-4},{"x":45.049870342936224,"y":0}]}],"marks":[{"type":"line","from":{"data":"c46f1608-7561-48ce-beba-9467a0b6481f"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"c46f1608-7561-48ce-beba-9467a0b6481f","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"c46f1608-7561-48ce-beba-9467a0b6481f","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"c46f1608-7561-48ce-beba-9467a0b6481f\", :values ({:x -74.92139415587361, :y 0} {:x -73.74520528823822, :y 8.502035918860538E-4} {:x -72.56901642060284, :y 0.0} {:x -71.39282755296745, :y 0.0} {:x -70.21663868533206, :y 0.0} {:x -69.04044981769667, :y 0.0} {:x -67.86426095006128, :y 0.0} {:x -66.68807208242589, :y 0.0} {:x -65.5118832147905, :y 0.0} {:x -64.33569434715511, :y 0.0} {:x -63.15950547951972, :y 0.0} {:x -61.983316611884334, :y 0.0} {:x -60.807127744248945, :y 0.0} {:x -59.630938876613556, :y 0.0} {:x -58.454750008978166, :y 0.0} {:x -57.27856114134278, :y 0.0} {:x -56.10237227370739, :y 0.0} {:x -54.926183406072, :y 0.0} {:x -53.74999453843661, :y 0.0} {:x -52.57380567080122, :y 0.0} {:x -51.39761680316583, :y 0.0} {:x -50.22142793553044, :y 0.0} {:x -49.045239067895054, :y 0.0} {:x -47.869050200259665, :y 0.0} {:x -46.692861332624275, :y 0.0} {:x -45.516672464988886, :y 0.0} {:x -44.3404835973535, :y 0.0} {:x -43.16429472971811, :y 0.0} {:x -41.98810586208272, :y 0.0} {:x -40.81191699444733, :y 0.0} {:x -39.63572812681194, :y 0.0} {:x -38.45953925917655, :y 0.0} {:x -37.28335039154116, :y 0.0017004071837721077} {:x -36.10716152390577, :y 0.0} {:x -34.930972656270384, :y 0.007651832326974485} {:x -33.754783788634995, :y 0.0} {:x -32.578594920999606, :y 0.0} {:x -31.402406053364214, :y 8.502035918860538E-4} {:x -30.22621718572882, :y 0.0} {:x -29.05002831809343, :y 0.0} {:x -27.873839450458036, :y 0.0} {:x -26.697650582822643, :y 0.0} {:x -25.52146171518725, :y 0.0} {:x -24.345272847551858, :y 0.0017004071837721077} {:x -23.169083979916465, :y 0.0} {:x -21.992895112281072, :y 0.0} {:x -20.81670624464568, :y 8.502035918860538E-4} {:x -19.640517377010287, :y 0.0017004071837721077} {:x -18.464328509374894, :y 0.0025506107756581614} {:x -17.2881396417395, :y 0.0} {:x -16.11195077410411, :y 0.0017004071837721077} {:x -14.935761906468718, :y 0.0} {:x -13.759573038833327, :y 8.502035918860538E-4} {:x -12.583384171197936, :y 8.502035918860538E-4} {:x -11.407195303562546, :y 0.004251017959430269} {:x -10.231006435927155, :y 0.0017004071837721077} {:x -9.054817568291764, :y 0.0034008143675442154} {:x -7.878628700656373, :y 0.005951425143202377} {:x -6.702439833020982, :y 0.011902850286404754} {:x -5.526250965385591, :y 0.0017004071837721077} {:x -4.3500620977502, :y 0.004251017959430269} {:x -3.173873230114809, :y 0.014453461062062915} {:x -1.9976843624794176, :y 0.016153868245835024} {:x -0.8214954948440263, :y 0.03230773649167005} {:x 0.35469337279136504, :y 0.0552632334725935} {:x 1.5308822404267564, :y 0.07056689812654247} {:x 2.7070711080621477, :y 0.06291506579956799} {:x 3.883259975697539, :y 0.04336038318618875} {:x 5.05944884333293, :y 0.0680162873508843} {:x 6.235637710968321, :y 0.0221052933890374} {:x 7.411826578603712, :y 0.014453461062062915} {:x 8.588015446239103, :y 0.005951425143202377} {:x 9.764204313874494, :y 0.025506107756581617} {:x 10.940393181509885, :y 0.028056718532239778} {:x 12.116582049145276, :y 0.03230773649167005} {:x 13.292770916780666, :y 0.03910936522675848} {:x 14.468959784416057, :y 0.016153868245835024} {:x 15.645148652051448, :y 0.038259161634872425} {:x 16.82133751968684, :y 0.034858347267328206} {:x 17.99752638732223, :y 0.0442105867780748} {:x 19.173715254957624, :y 0.0331579400835561} {:x 20.349904122593017, :y 0.024655904164695562} {:x 21.52609299022841, :y 0.029757125716011884} {:x 22.702281857863802, :y 0.0110526466945187} {:x 23.878470725499195, :y 0.008502035918860538} {:x 25.054659593134588, :y 0.009352239510746593} {:x 26.23084846076998, :y 0.004251017959430269} {:x 27.407037328405373, :y 0.004251017959430269} {:x 28.583226196040766, :y 0.0} {:x 29.75941506367616, :y 0.0} {:x 30.93560393131155, :y 0.0034008143675442154} {:x 32.111792798946944, :y 8.502035918860538E-4} {:x 33.28798166658233, :y 8.502035918860538E-4} {:x 34.46417053421772, :y 8.502035918860538E-4} {:x 35.64035940185311, :y 0.0} {:x 36.8165482694885, :y 0.0} {:x 37.99273713712389, :y 0.0} {:x 39.16892600475928, :y 0.0} {:x 40.34511487239467, :y 0.0} {:x 41.521303740030056, :y 0.0} {:x 42.697492607665446, :y 0.0} {:x 43.873681475300835, :y 8.502035918860538E-4} {:x 45.049870342936224, :y 0})}], :marks [{:type \"line\", :from {:data \"c46f1608-7561-48ce-beba-9467a0b6481f\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"c46f1608-7561-48ce-beba-9467a0b6481f\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"c46f1608-7561-48ce-beba-9467a0b6481f\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(defquery dirichlet-process-mixture-stick-breaking-prior
  [input-data]
  (let
    [concentration 1.72
     base (fn []
            (let [v (/ 1.0 (sample (gamma 1 10)))]
              (list (sample (normal 0 (sqrt (* v 10)))) 
                    (sqrt v))))
     obs-param (DPmem concentration base)]

    ; observe draws from the DP mixture
    #_(map
      (fn [value]
        (observe (apply normal (obs-param)) value))
      input-data)

    ; predict a data point from the DP mixture
    (sample (apply normal (obs-param)))))

(def num-particles 1000)
(def smc-states (take num-particles (infer :smc dirichlet-process-mixture-stick-breaking-prior [test-observations] :number-of-particles 100)))
(plot/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results smc-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"36f12138-60c2-4d7b-a9fe-5b039bbb1604","values":[{"x":-155.7143839474302,"y":0},{"x":-151.3724301791135,"y":9.2124426316744E-4},{"x":-147.0304764107968,"y":0.0},{"x":-142.6885226424801,"y":0.0},{"x":-138.3465688741634,"y":0.0},{"x":-134.0046151058467,"y":0.0},{"x":-129.66266133753,"y":0.0},{"x":-125.32070756921331,"y":0.0},{"x":-120.97875380089661,"y":0.0},{"x":-116.63680003257991,"y":0.0},{"x":-112.29484626426321,"y":0.0},{"x":-107.95289249594651,"y":2.3031106579186E-4},{"x":-103.61093872762982,"y":0.0},{"x":-99.26898495931312,"y":0.0},{"x":-94.92703119099642,"y":0.0},{"x":-90.58507742267972,"y":0.0},{"x":-86.24312365436302,"y":2.3031106579186E-4},{"x":-81.90116988604632,"y":2.3031106579186E-4},{"x":-77.55921611772962,"y":4.6062213158372E-4},{"x":-73.21726234941292,"y":0.0},{"x":-68.87530858109622,"y":4.6062213158372E-4},{"x":-64.53335481277952,"y":2.3031106579186E-4},{"x":-60.19140104446283,"y":2.3031106579186E-4},{"x":-55.84944727614614,"y":4.6062213158372E-4},{"x":-51.507493507829444,"y":4.6062213158372E-4},{"x":-47.16553973951275,"y":0.00161217746054302},{"x":-42.82358597119606,"y":2.3031106579186E-4},{"x":-38.48163220287937,"y":4.6062213158372E-4},{"x":-34.139678434562676,"y":0.00276373278950232},{"x":-29.797724666245983,"y":0.0025334217237104597},{"x":-25.45577089792929,"y":0.00184248852633488},{"x":-21.1138171296126,"y":0.00875182050009068},{"x":-16.771863361295907,"y":0.007600265171131379},{"x":-12.429909592979214,"y":0.01635208567122206},{"x":-8.087955824662522,"y":0.019806751658099957},{"x":-3.74600205634583,"y":0.026716083631855757},{"x":0.5959517119708622,"y":0.034776970934570856},{"x":4.937905480287554,"y":0.0299404385529418},{"x":9.279859248604247,"y":0.02164924018443484},{"x":13.621813016920939,"y":0.01888550739493252},{"x":17.96376678523763,"y":0.008060887302715099},{"x":22.305720553554323,"y":0.006679020907963939},{"x":26.647674321871015,"y":0.0025334217237104597},{"x":30.989628090187708,"y":0.0029940438552941797},{"x":35.3315818585044,"y":0.0023031106579186},{"x":39.67353562682109,"y":6.9093319737558E-4},{"x":44.015489395137784,"y":0.0025334217237104597},{"x":48.35744316345448,"y":6.9093319737558E-4},{"x":52.69939693177117,"y":4.6062213158372E-4},{"x":57.04135070008786,"y":6.9093319737558E-4},{"x":61.38330446840455,"y":4.6062213158372E-4},{"x":65.72525823672125,"y":6.9093319737558E-4},{"x":70.06721200503793,"y":0.0},{"x":74.40916577335463,"y":4.6062213158372E-4},{"x":78.75111954167133,"y":6.9093319737558E-4},{"x":83.09307330998803,"y":0.0011515553289593},{"x":87.43502707830473,"y":0.0},{"x":91.77698084662143,"y":0.0},{"x":96.11893461493813,"y":2.3031106579186E-4},{"x":100.46088838325483,"y":0.0},{"x":104.80284215157153,"y":0.0},{"x":109.14479591988822,"y":0.0},{"x":113.48674968820492,"y":0.0},{"x":117.82870345652162,"y":0.0},{"x":122.17065722483832,"y":0.0},{"x":126.51261099315502,"y":0.0},{"x":130.85456476147172,"y":9.2124426316744E-4},{"x":135.19651852978842,"y":0.0},{"x":139.53847229810512,"y":0.0},{"x":143.88042606642182,"y":0.0},{"x":148.22237983473852,"y":0.0},{"x":152.56433360305522,"y":0.0},{"x":156.90628737137192,"y":0.0},{"x":161.24824113968862,"y":0.0},{"x":165.59019490800532,"y":0.0},{"x":169.93214867632202,"y":0.0},{"x":174.27410244463871,"y":0.0},{"x":178.6160562129554,"y":0.0},{"x":182.9580099812721,"y":0.0},{"x":187.2999637495888,"y":0.0},{"x":191.6419175179055,"y":0.0},{"x":195.9838712862222,"y":0.0},{"x":200.3258250545389,"y":0.0},{"x":204.6677788228556,"y":0.0},{"x":209.0097325911723,"y":0.0},{"x":213.351686359489,"y":0.0},{"x":217.6936401278057,"y":0.0},{"x":222.0355938961224,"y":0.0},{"x":226.3775476644391,"y":0.0},{"x":230.7195014327558,"y":0.0},{"x":235.0614552010725,"y":0.0},{"x":239.4034089693892,"y":0.0},{"x":243.7453627377059,"y":0.0},{"x":248.0873165060226,"y":0.0},{"x":252.4292702743393,"y":0.0},{"x":256.771224042656,"y":0.0},{"x":261.1131778109727,"y":0.0},{"x":265.45513157928934,"y":0.0},{"x":269.797085347606,"y":0.0},{"x":274.1390391159227,"y":0.0},{"x":278.48099288423936,"y":2.3031106579186E-4},{"x":282.822946652556,"y":0}]}],"marks":[{"type":"line","from":{"data":"36f12138-60c2-4d7b-a9fe-5b039bbb1604"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"36f12138-60c2-4d7b-a9fe-5b039bbb1604","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"36f12138-60c2-4d7b-a9fe-5b039bbb1604","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\", :values ({:x -155.7143839474302, :y 0} {:x -151.3724301791135, :y 9.2124426316744E-4} {:x -147.0304764107968, :y 0.0} {:x -142.6885226424801, :y 0.0} {:x -138.3465688741634, :y 0.0} {:x -134.0046151058467, :y 0.0} {:x -129.66266133753, :y 0.0} {:x -125.32070756921331, :y 0.0} {:x -120.97875380089661, :y 0.0} {:x -116.63680003257991, :y 0.0} {:x -112.29484626426321, :y 0.0} {:x -107.95289249594651, :y 2.3031106579186E-4} {:x -103.61093872762982, :y 0.0} {:x -99.26898495931312, :y 0.0} {:x -94.92703119099642, :y 0.0} {:x -90.58507742267972, :y 0.0} {:x -86.24312365436302, :y 2.3031106579186E-4} {:x -81.90116988604632, :y 2.3031106579186E-4} {:x -77.55921611772962, :y 4.6062213158372E-4} {:x -73.21726234941292, :y 0.0} {:x -68.87530858109622, :y 4.6062213158372E-4} {:x -64.53335481277952, :y 2.3031106579186E-4} {:x -60.19140104446283, :y 2.3031106579186E-4} {:x -55.84944727614614, :y 4.6062213158372E-4} {:x -51.507493507829444, :y 4.6062213158372E-4} {:x -47.16553973951275, :y 0.00161217746054302} {:x -42.82358597119606, :y 2.3031106579186E-4} {:x -38.48163220287937, :y 4.6062213158372E-4} {:x -34.139678434562676, :y 0.00276373278950232} {:x -29.797724666245983, :y 0.0025334217237104597} {:x -25.45577089792929, :y 0.00184248852633488} {:x -21.1138171296126, :y 0.00875182050009068} {:x -16.771863361295907, :y 0.007600265171131379} {:x -12.429909592979214, :y 0.01635208567122206} {:x -8.087955824662522, :y 0.019806751658099957} {:x -3.74600205634583, :y 0.026716083631855757} {:x 0.5959517119708622, :y 0.034776970934570856} {:x 4.937905480287554, :y 0.0299404385529418} {:x 9.279859248604247, :y 0.02164924018443484} {:x 13.621813016920939, :y 0.01888550739493252} {:x 17.96376678523763, :y 0.008060887302715099} {:x 22.305720553554323, :y 0.006679020907963939} {:x 26.647674321871015, :y 0.0025334217237104597} {:x 30.989628090187708, :y 0.0029940438552941797} {:x 35.3315818585044, :y 0.0023031106579186} {:x 39.67353562682109, :y 6.9093319737558E-4} {:x 44.015489395137784, :y 0.0025334217237104597} {:x 48.35744316345448, :y 6.9093319737558E-4} {:x 52.69939693177117, :y 4.6062213158372E-4} {:x 57.04135070008786, :y 6.9093319737558E-4} {:x 61.38330446840455, :y 4.6062213158372E-4} {:x 65.72525823672125, :y 6.9093319737558E-4} {:x 70.06721200503793, :y 0.0} {:x 74.40916577335463, :y 4.6062213158372E-4} {:x 78.75111954167133, :y 6.9093319737558E-4} {:x 83.09307330998803, :y 0.0011515553289593} {:x 87.43502707830473, :y 0.0} {:x 91.77698084662143, :y 0.0} {:x 96.11893461493813, :y 2.3031106579186E-4} {:x 100.46088838325483, :y 0.0} {:x 104.80284215157153, :y 0.0} {:x 109.14479591988822, :y 0.0} {:x 113.48674968820492, :y 0.0} {:x 117.82870345652162, :y 0.0} {:x 122.17065722483832, :y 0.0} {:x 126.51261099315502, :y 0.0} {:x 130.85456476147172, :y 9.2124426316744E-4} {:x 135.19651852978842, :y 0.0} {:x 139.53847229810512, :y 0.0} {:x 143.88042606642182, :y 0.0} {:x 148.22237983473852, :y 0.0} {:x 152.56433360305522, :y 0.0} {:x 156.90628737137192, :y 0.0} {:x 161.24824113968862, :y 0.0} {:x 165.59019490800532, :y 0.0} {:x 169.93214867632202, :y 0.0} {:x 174.27410244463871, :y 0.0} {:x 178.6160562129554, :y 0.0} {:x 182.9580099812721, :y 0.0} {:x 187.2999637495888, :y 0.0} {:x 191.6419175179055, :y 0.0} {:x 195.9838712862222, :y 0.0} {:x 200.3258250545389, :y 0.0} {:x 204.6677788228556, :y 0.0} {:x 209.0097325911723, :y 0.0} {:x 213.351686359489, :y 0.0} {:x 217.6936401278057, :y 0.0} {:x 222.0355938961224, :y 0.0} {:x 226.3775476644391, :y 0.0} {:x 230.7195014327558, :y 0.0} {:x 235.0614552010725, :y 0.0} {:x 239.4034089693892, :y 0.0} {:x 243.7453627377059, :y 0.0} {:x 248.0873165060226, :y 0.0} {:x 252.4292702743393, :y 0.0} {:x 256.771224042656, :y 0.0} {:x 261.1131778109727, :y 0.0} {:x 265.45513157928934, :y 0.0} {:x 269.797085347606, :y 0.0} {:x 274.1390391159227, :y 0.0} {:x 278.48099288423936, :y 2.3031106579186E-4} {:x 282.822946652556, :y 0})}], :marks [{:type \"line\", :from {:data \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(def input-data
  (list -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
        7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
        3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3))

(def samples
  (take 5000
             (doquery :smc
                      dirichlet-process-mixture-stick-breaking
                      [input-data]
                      :number-of-particles 100)))

(def predictions (map :result samples))

(plot/histogram predictions :bins 100 :plot-range [[-8 15] :all])

;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"fa231430-02c6-43fb-871b-55d1465f36bd","values":[{"x":-8.0,"y":0},{"x":-7.77,"y":0.0},{"x":-7.539999999999999,"y":0.0},{"x":-7.309999999999999,"y":2.0},{"x":-7.079999999999998,"y":3.0},{"x":-6.849999999999998,"y":1.0},{"x":-6.619999999999997,"y":1.0},{"x":-6.389999999999997,"y":3.0},{"x":-6.159999999999997,"y":1.0},{"x":-5.929999999999996,"y":3.0},{"x":-5.699999999999996,"y":3.0},{"x":-5.469999999999995,"y":4.0},{"x":-5.239999999999995,"y":4.0},{"x":-5.0099999999999945,"y":1.0},{"x":-4.779999999999994,"y":7.0},{"x":-4.549999999999994,"y":8.0},{"x":-4.319999999999993,"y":5.0},{"x":-4.089999999999993,"y":6.0},{"x":-3.8599999999999928,"y":4.0},{"x":-3.629999999999993,"y":5.0},{"x":-3.399999999999993,"y":8.0},{"x":-3.169999999999993,"y":8.0},{"x":-2.939999999999993,"y":5.0},{"x":-2.709999999999993,"y":9.0},{"x":-2.479999999999993,"y":15.0},{"x":-2.249999999999993,"y":22.0},{"x":-2.019999999999993,"y":20.0},{"x":-1.789999999999993,"y":29.0},{"x":-1.559999999999993,"y":89.0},{"x":-1.329999999999993,"y":220.0},{"x":-1.099999999999993,"y":549.0},{"x":-0.869999999999993,"y":805.0},{"x":-0.639999999999993,"y":596.0},{"x":-0.40999999999999304,"y":252.0},{"x":-0.17999999999999303,"y":130.0},{"x":0.05000000000000698,"y":60.0},{"x":0.280000000000007,"y":53.0},{"x":0.510000000000007,"y":36.0},{"x":0.740000000000007,"y":34.0},{"x":0.970000000000007,"y":41.0},{"x":1.200000000000007,"y":37.0},{"x":1.430000000000007,"y":38.0},{"x":1.660000000000007,"y":32.0},{"x":1.890000000000007,"y":35.0},{"x":2.120000000000007,"y":50.0},{"x":2.350000000000007,"y":70.0},{"x":2.580000000000007,"y":91.0},{"x":2.810000000000007,"y":115.0},{"x":3.040000000000007,"y":126.0},{"x":3.270000000000007,"y":133.0},{"x":3.500000000000007,"y":83.0},{"x":3.730000000000007,"y":59.0},{"x":3.960000000000007,"y":45.0},{"x":4.1900000000000075,"y":32.0},{"x":4.420000000000008,"y":18.0},{"x":4.650000000000008,"y":23.0},{"x":4.880000000000009,"y":24.0},{"x":5.110000000000009,"y":32.0},{"x":5.34000000000001,"y":20.0},{"x":5.57000000000001,"y":29.0},{"x":5.8000000000000105,"y":46.0},{"x":6.030000000000011,"y":45.0},{"x":6.260000000000011,"y":63.0},{"x":6.490000000000012,"y":68.0},{"x":6.720000000000012,"y":74.0},{"x":6.950000000000013,"y":103.0},{"x":7.180000000000013,"y":78.0},{"x":7.4100000000000135,"y":74.0},{"x":7.640000000000014,"y":66.0},{"x":7.870000000000014,"y":42.0},{"x":8.100000000000014,"y":37.0},{"x":8.330000000000014,"y":34.0},{"x":8.560000000000015,"y":22.0},{"x":8.790000000000015,"y":15.0},{"x":9.020000000000016,"y":15.0},{"x":9.250000000000016,"y":12.0},{"x":9.480000000000016,"y":11.0},{"x":9.710000000000017,"y":3.0},{"x":9.940000000000017,"y":6.0},{"x":10.170000000000018,"y":3.0},{"x":10.400000000000018,"y":5.0},{"x":10.630000000000019,"y":1.0},{"x":10.860000000000019,"y":2.0},{"x":11.09000000000002,"y":2.0},{"x":11.32000000000002,"y":3.0},{"x":11.55000000000002,"y":2.0},{"x":11.78000000000002,"y":0.0},{"x":12.010000000000021,"y":0.0},{"x":12.240000000000022,"y":2.0},{"x":12.470000000000022,"y":1.0},{"x":12.700000000000022,"y":1.0},{"x":12.930000000000023,"y":0.0},{"x":13.160000000000023,"y":2.0},{"x":13.390000000000024,"y":3.0},{"x":13.620000000000024,"y":1.0},{"x":13.850000000000025,"y":1.0},{"x":14.080000000000025,"y":0.0},{"x":14.310000000000025,"y":1.0},{"x":14.540000000000026,"y":0.0},{"x":14.770000000000026,"y":0.0},{"x":15.000000000000027,"y":0.0},{"x":15.230000000000027,"y":0}]}],"marks":[{"type":"line","from":{"data":"fa231430-02c6-43fb-871b-55d1465f36bd"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":[-8,15]},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"fa231430-02c6-43fb-871b-55d1465f36bd","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"fa231430-02c6-43fb-871b-55d1465f36bd\", :values ({:x -8.0, :y 0} {:x -7.77, :y 0.0} {:x -7.539999999999999, :y 0.0} {:x -7.309999999999999, :y 2.0} {:x -7.079999999999998, :y 3.0} {:x -6.849999999999998, :y 1.0} {:x -6.619999999999997, :y 1.0} {:x -6.389999999999997, :y 3.0} {:x -6.159999999999997, :y 1.0} {:x -5.929999999999996, :y 3.0} {:x -5.699999999999996, :y 3.0} {:x -5.469999999999995, :y 4.0} {:x -5.239999999999995, :y 4.0} {:x -5.0099999999999945, :y 1.0} {:x -4.779999999999994, :y 7.0} {:x -4.549999999999994, :y 8.0} {:x -4.319999999999993, :y 5.0} {:x -4.089999999999993, :y 6.0} {:x -3.8599999999999928, :y 4.0} {:x -3.629999999999993, :y 5.0} {:x -3.399999999999993, :y 8.0} {:x -3.169999999999993, :y 8.0} {:x -2.939999999999993, :y 5.0} {:x -2.709999999999993, :y 9.0} {:x -2.479999999999993, :y 15.0} {:x -2.249999999999993, :y 22.0} {:x -2.019999999999993, :y 20.0} {:x -1.789999999999993, :y 29.0} {:x -1.559999999999993, :y 89.0} {:x -1.329999999999993, :y 220.0} {:x -1.099999999999993, :y 549.0} {:x -0.869999999999993, :y 805.0} {:x -0.639999999999993, :y 596.0} {:x -0.40999999999999304, :y 252.0} {:x -0.17999999999999303, :y 130.0} {:x 0.05000000000000698, :y 60.0} {:x 0.280000000000007, :y 53.0} {:x 0.510000000000007, :y 36.0} {:x 0.740000000000007, :y 34.0} {:x 0.970000000000007, :y 41.0} {:x 1.200000000000007, :y 37.0} {:x 1.430000000000007, :y 38.0} {:x 1.660000000000007, :y 32.0} {:x 1.890000000000007, :y 35.0} {:x 2.120000000000007, :y 50.0} {:x 2.350000000000007, :y 70.0} {:x 2.580000000000007, :y 91.0} {:x 2.810000000000007, :y 115.0} {:x 3.040000000000007, :y 126.0} {:x 3.270000000000007, :y 133.0} {:x 3.500000000000007, :y 83.0} {:x 3.730000000000007, :y 59.0} {:x 3.960000000000007, :y 45.0} {:x 4.1900000000000075, :y 32.0} {:x 4.420000000000008, :y 18.0} {:x 4.650000000000008, :y 23.0} {:x 4.880000000000009, :y 24.0} {:x 5.110000000000009, :y 32.0} {:x 5.34000000000001, :y 20.0} {:x 5.57000000000001, :y 29.0} {:x 5.8000000000000105, :y 46.0} {:x 6.030000000000011, :y 45.0} {:x 6.260000000000011, :y 63.0} {:x 6.490000000000012, :y 68.0} {:x 6.720000000000012, :y 74.0} {:x 6.950000000000013, :y 103.0} {:x 7.180000000000013, :y 78.0} {:x 7.4100000000000135, :y 74.0} {:x 7.640000000000014, :y 66.0} {:x 7.870000000000014, :y 42.0} {:x 8.100000000000014, :y 37.0} {:x 8.330000000000014, :y 34.0} {:x 8.560000000000015, :y 22.0} {:x 8.790000000000015, :y 15.0} {:x 9.020000000000016, :y 15.0} {:x 9.250000000000016, :y 12.0} {:x 9.480000000000016, :y 11.0} {:x 9.710000000000017, :y 3.0} {:x 9.940000000000017, :y 6.0} {:x 10.170000000000018, :y 3.0} {:x 10.400000000000018, :y 5.0} {:x 10.630000000000019, :y 1.0} {:x 10.860000000000019, :y 2.0} {:x 11.09000000000002, :y 2.0} {:x 11.32000000000002, :y 3.0} {:x 11.55000000000002, :y 2.0} {:x 11.78000000000002, :y 0.0} {:x 12.010000000000021, :y 0.0} {:x 12.240000000000022, :y 2.0} {:x 12.470000000000022, :y 1.0} {:x 12.700000000000022, :y 1.0} {:x 12.930000000000023, :y 0.0} {:x 13.160000000000023, :y 2.0} {:x 13.390000000000024, :y 3.0} {:x 13.620000000000024, :y 1.0} {:x 13.850000000000025, :y 1.0} {:x 14.080000000000025, :y 0.0} {:x 14.310000000000025, :y 1.0} {:x 14.540000000000026, :y 0.0} {:x 14.770000000000026, :y 0.0} {:x 15.000000000000027, :y 0.0} {:x 15.230000000000027, :y 0})}], :marks [{:type \"line\", :from {:data \"fa231430-02c6-43fb-871b-55d1465f36bd\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain [-8 15]} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"fa231430-02c6-43fb-871b-55d1465f36bd\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@

;; @@
