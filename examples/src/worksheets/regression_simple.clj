;; gorilla-repl.fileformat = 1

;; **
;;; # Simple polynomial regression
;; **

;; @@
(ns regression
  (:require [gorilla-plot.core :as plot]
            [anglican.stat :as s]
            [anglican.stat :refer [empirical-distribution collect-results]]
            anglican.infcomp.csis
            anglican.smc
            [anglican.infcomp.network :refer :all]
            [anglican.infcomp.prior :refer [sample-from-prior]]
            [anglican.inference :refer [infer]]
            [helpers.general :refer [empirical-MAP]]
            [anglican.stat :refer [collect-results]])
  (:use [anglican core emit runtime])
  (:import [javax.imageio ImageIO]
           [java.io File]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; ## Generative model
;; **

;; @@
(defn poly [w x]
  (reduce #(-> %1 (* x) (+ %2)) (reverse w)))

(with-primitive-procedures [poly]
  (defquery regress [data-x data-y] 
  (let [w0 (sample "w0" (normal 0 2))
        w1 (sample "w1" (normal 0 2))
        w2 (sample "w2" (normal 0 2))]
    (map #(observe (normal (poly [w0 w1 w2] %1) 0.01) %2) data-x data-y)
    [w0 w1 w2])))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;regression/regress</span>","value":"#'regression/regress"}
;; <=

;; **
;;; ## Train a compilation artifact
;; **

;; @@
(defn combine-observes-fn [observes]
  (vec (map :value observes)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;regression/combine-observes-fn</span>","value":"#'regression/combine-observes-fn"}
;; <=

;; @@
(sample-observes-from-prior regress [[1 2 3] [2 4 9]])
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:time-index 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:observe-address</span>","value":":observe-address"},{"type":"html","content":"<span class='clj-symbol'>O27435</span>","value":"O27435"}],"value":"[:observe-address O27435]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:observe-instance</span>","value":":observe-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:observe-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-3.1452462248223987</span>","value":"-3.1452462248223987"}],"value":"[:value -3.1452462248223987]"}],"value":"{:time-index 0, :observe-address O27435, :observe-instance 0, :value -3.1452462248223987}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:time-index 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:observe-address</span>","value":":observe-address"},{"type":"html","content":"<span class='clj-symbol'>O27435</span>","value":"O27435"}],"value":"[:observe-address O27435]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:observe-instance</span>","value":":observe-instance"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:observe-instance 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-7.9209826915028385</span>","value":"-7.9209826915028385"}],"value":"[:value -7.9209826915028385]"}],"value":"{:time-index 1, :observe-address O27435, :observe-instance 1, :value -7.9209826915028385}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:time-index 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:observe-address</span>","value":":observe-address"},{"type":"html","content":"<span class='clj-symbol'>O27435</span>","value":"O27435"}],"value":"[:observe-address O27435]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:observe-instance</span>","value":":observe-instance"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:observe-instance 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-14.48406618161862</span>","value":"-14.48406618161862"}],"value":"[:value -14.48406618161862]"}],"value":"{:time-index 2, :observe-address O27435, :observe-instance 2, :value -14.48406618161862}"}],"value":"[{:time-index 0, :observe-address O27435, :observe-instance 0, :value -3.1452462248223987} {:time-index 1, :observe-address O27435, :observe-instance 1, :value -7.9209826915028385} {:time-index 2, :observe-address O27435, :observe-instance 2, :value -14.48406618161862}]"}
;; <=

;; @@
(combine-observes-fn (sample-observes-from-prior regress [[1 2 3] [2 4 9]]))
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-double'>-2.4481525899017407</span>","value":"-2.4481525899017407"},{"type":"html","content":"<span class='clj-double'>-5.190016929823806</span>","value":"-5.190016929823806"},{"type":"html","content":"<span class='clj-double'>-8.19015981936462</span>","value":"-8.19015981936462"}],"value":"[-2.4481525899017407 -5.190016929823806 -8.19015981936462]"}
;; <=

;; @@
;; Start the Torch connection
(def torch-connection (start-torch-connection regress [[1 2 3 4] [2 4 9 16]] combine-observes-fn))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;regression/torch-connection</span>","value":"#'regression/torch-connection"}
;; <=

;; @@
(stop-torch-connection torch-connection)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-string'>&quot;Torch connection terminated.&quot;</span>","value":"\"Torch connection terminated.\""}
;; <=

;; @@
(def test-data [[1 2 3 4] [20 40 90 160]])
(def num-particles 100)
(def w-map 
  (->> (doquery :importance regress test-data :number-of-particles num-particles)
    (take num-particles)
    s/collect-results
    (empirical-MAP)))
w-map
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-double'>2.7741314869263984</span>","value":"2.7741314869263984"},{"type":"html","content":"<span class='clj-double'>-0.0350547156004849</span>","value":"-0.0350547156004849"},{"type":"html","content":"<span class='clj-double'>4.948735802591503</span>","value":"4.948735802591503"}],"value":"[2.7741314869263984 -0.0350547156004849 4.948735802591503]"}
;; <=

;; @@
(plot/compose
  (plot/list-plot (map #(vec [%1 %2]) (first test-data) (second test-data)))
  (plot/plot (partial poly w-map) [(apply min (first test-data)) (apply max (first test-data))]))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"4e436413-20a9-44dd-a1ea-2bb7846f2f52","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"4e436413-20a9-44dd-a1ea-2bb7846f2f52","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}],"data":[{"name":"4e436413-20a9-44dd-a1ea-2bb7846f2f52","values":[{"x":1,"y":20},{"x":2,"y":40},{"x":3,"y":90},{"x":4,"y":160}]},{"name":"ebb6c5ea-6be2-4a3a-bae0-d98995af29ff","values":[{"x":1,"y":7.687812573917416},{"x":1.0299999993294477,"y":7.988138936014855},{"x":1.0599999986588955,"y":8.297373022158752},{"x":1.0899999979883432,"y":8.615514832349108},{"x":1.119999997317791,"y":8.942564366585922},{"x":1.1499999966472387,"y":9.278521624869196},{"x":1.1799999959766865,"y":9.623386607198926},{"x":1.2099999953061342,"y":9.977159313575115},{"x":1.239999994635582,"y":10.339839743997763},{"x":1.2699999939650297,"y":10.71142789846687},{"x":1.2999999932944775,"y":11.091923776982433},{"x":1.3299999926239252,"y":11.481327379544457},{"x":1.359999991953373,"y":11.879638706152937},{"x":1.3899999912828207,"y":12.286857756807878},{"x":1.4199999906122684,"y":12.702984531509275},{"x":1.4499999899417162,"y":13.128019030257132},{"x":1.479999989271164,"y":13.561961253051447},{"x":1.5099999886006117,"y":14.00481119989222},{"x":1.5399999879300594,"y":14.456568870779451},{"x":1.5699999872595072,"y":14.917234265713143},{"x":1.599999986588955,"y":15.38680738469329},{"x":1.6299999859184027,"y":15.865288227719898},{"x":1.6599999852478504,"y":16.352676794792963},{"x":1.6899999845772982,"y":16.848973085912487},{"x":1.719999983906746,"y":17.35417710107847},{"x":1.7499999832361937,"y":17.86828884029091},{"x":1.7799999825656414,"y":18.391308303549806},{"x":1.8099999818950891,"y":18.923235490855163},{"x":1.839999981224537,"y":19.464070402206985},{"x":1.8699999805539846,"y":20.013813037605253},{"x":1.8999999798834324,"y":20.572463397049987},{"x":1.9299999792128801,"y":21.14002148054118},{"x":1.9599999785423279,"y":21.71648728807883},{"x":1.9899999778717756,"y":22.301860819662934},{"x":2.0199999772012234,"y":22.896142075293504},{"x":2.049999976530671,"y":23.499331054970526},{"x":2.079999975860119,"y":24.111427758694013},{"x":2.1099999751895666,"y":24.732432186463946},{"x":2.1399999745190144,"y":25.36234433828035},{"x":2.169999973848462,"y":26.00116421414321},{"x":2.19999997317791,"y":26.648891814052526},{"x":2.2299999725073576,"y":27.305527138008294},{"x":2.2599999718368053,"y":27.97107018601053},{"x":2.289999971166253,"y":28.645520958059222},{"x":2.319999970495701,"y":29.328879454154375},{"x":2.3499999698251486,"y":30.02114567429598},{"x":2.3799999691545963,"y":30.72231961848405},{"x":2.409999968484044,"y":31.432401286718573},{"x":2.439999967813492,"y":32.15139067899956},{"x":2.4699999671429396,"y":32.879287795326995},{"x":2.4999999664723873,"y":33.6160926357009},{"x":2.529999965801835,"y":34.36180520012126},{"x":2.559999965131283,"y":35.11642548858808},{"x":2.5899999644607306,"y":35.879953501101355},{"x":2.6199999637901783,"y":36.65238923766108},{"x":2.649999963119626,"y":37.43373269826728},{"x":2.679999962449074,"y":38.22398388291993},{"x":2.7099999617785215,"y":39.02314279161904},{"x":2.7399999611079693,"y":39.83120942436461},{"x":2.769999960437417,"y":40.64818378115663},{"x":2.7999999597668648,"y":41.47406586199512},{"x":2.8299999590963125,"y":42.308855666880056},{"x":2.8599999584257603,"y":43.15255319581146},{"x":2.889999957755208,"y":44.005158448789324},{"x":2.9199999570846558,"y":44.86667142581364},{"x":2.9499999564141035,"y":45.73709212688441},{"x":2.9799999557435513,"y":46.61642055200165},{"x":3.009999955072999,"y":47.504656701165345},{"x":3.0399999544024467,"y":48.40180057437549},{"x":3.0699999537318945,"y":49.3078521716321},{"x":3.0999999530613422,"y":50.22281149293517},{"x":3.12999995239079,"y":51.1466785382847},{"x":3.1599999517202377,"y":52.07945330768069},{"x":3.1899999510496855,"y":53.02113580112312},{"x":3.2199999503791332,"y":53.97172601861203},{"x":3.249999949708581,"y":54.93122396014739},{"x":3.2799999490380287,"y":55.899629625729204},{"x":3.3099999483674765,"y":56.87694301535749},{"x":3.339999947696924,"y":57.86316412903222},{"x":3.369999947026372,"y":58.85829296675341},{"x":3.3999999463558197,"y":59.862329528521066},{"x":3.4299999456852674,"y":60.87527381433517},{"x":3.459999945014715,"y":61.897125824195754},{"x":3.489999944344163,"y":62.92788555810277},{"x":3.5199999436736107,"y":63.96755301605626},{"x":3.5499999430030584,"y":65.01612819805621},{"x":3.579999942332506,"y":66.0736111041026},{"x":3.609999941661954,"y":67.14000173419545},{"x":3.6399999409914017,"y":68.21530008833479},{"x":3.6699999403208494,"y":69.29950616652056},{"x":3.699999939650297,"y":70.3926199687528},{"x":3.729999938979745,"y":71.49464149503149},{"x":3.7599999383091927,"y":72.60557074535663},{"x":3.7899999376386404,"y":73.72540771972825},{"x":3.819999936968088,"y":74.85415241814633},{"x":3.849999936297536,"y":75.99180484061084},{"x":3.8799999356269836,"y":77.13836498712183},{"x":3.9099999349564314,"y":78.29383285767928},{"x":3.939999934285879,"y":79.45820845228319},{"x":3.969999933615327,"y":80.63149177093355},{"x":3.9999999329447746,"y":81.81368281363036}]}],"marks":[{"type":"symbol","from":{"data":"4e436413-20a9-44dd-a1ea-2bb7846f2f52"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}},{"type":"line","from":{"data":"ebb6c5ea-6be2-4a3a-bae0-d98995af29ff"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"4e436413-20a9-44dd-a1ea-2bb7846f2f52\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"4e436413-20a9-44dd-a1ea-2bb7846f2f52\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"4e436413-20a9-44dd-a1ea-2bb7846f2f52\", :values ({:x 1, :y 20} {:x 2, :y 40} {:x 3, :y 90} {:x 4, :y 160})} {:name \"ebb6c5ea-6be2-4a3a-bae0-d98995af29ff\", :values ({:x 1, :y 7.687812573917416} {:x 1.0299999993294477, :y 7.988138936014855} {:x 1.0599999986588955, :y 8.297373022158752} {:x 1.0899999979883432, :y 8.615514832349108} {:x 1.119999997317791, :y 8.942564366585922} {:x 1.1499999966472387, :y 9.278521624869196} {:x 1.1799999959766865, :y 9.623386607198926} {:x 1.2099999953061342, :y 9.977159313575115} {:x 1.239999994635582, :y 10.339839743997763} {:x 1.2699999939650297, :y 10.71142789846687} {:x 1.2999999932944775, :y 11.091923776982433} {:x 1.3299999926239252, :y 11.481327379544457} {:x 1.359999991953373, :y 11.879638706152937} {:x 1.3899999912828207, :y 12.286857756807878} {:x 1.4199999906122684, :y 12.702984531509275} {:x 1.4499999899417162, :y 13.128019030257132} {:x 1.479999989271164, :y 13.561961253051447} {:x 1.5099999886006117, :y 14.00481119989222} {:x 1.5399999879300594, :y 14.456568870779451} {:x 1.5699999872595072, :y 14.917234265713143} {:x 1.599999986588955, :y 15.38680738469329} {:x 1.6299999859184027, :y 15.865288227719898} {:x 1.6599999852478504, :y 16.352676794792963} {:x 1.6899999845772982, :y 16.848973085912487} {:x 1.719999983906746, :y 17.35417710107847} {:x 1.7499999832361937, :y 17.86828884029091} {:x 1.7799999825656414, :y 18.391308303549806} {:x 1.8099999818950891, :y 18.923235490855163} {:x 1.839999981224537, :y 19.464070402206985} {:x 1.8699999805539846, :y 20.013813037605253} {:x 1.8999999798834324, :y 20.572463397049987} {:x 1.9299999792128801, :y 21.14002148054118} {:x 1.9599999785423279, :y 21.71648728807883} {:x 1.9899999778717756, :y 22.301860819662934} {:x 2.0199999772012234, :y 22.896142075293504} {:x 2.049999976530671, :y 23.499331054970526} {:x 2.079999975860119, :y 24.111427758694013} {:x 2.1099999751895666, :y 24.732432186463946} {:x 2.1399999745190144, :y 25.36234433828035} {:x 2.169999973848462, :y 26.00116421414321} {:x 2.19999997317791, :y 26.648891814052526} {:x 2.2299999725073576, :y 27.305527138008294} {:x 2.2599999718368053, :y 27.97107018601053} {:x 2.289999971166253, :y 28.645520958059222} {:x 2.319999970495701, :y 29.328879454154375} {:x 2.3499999698251486, :y 30.02114567429598} {:x 2.3799999691545963, :y 30.72231961848405} {:x 2.409999968484044, :y 31.432401286718573} {:x 2.439999967813492, :y 32.15139067899956} {:x 2.4699999671429396, :y 32.879287795326995} {:x 2.4999999664723873, :y 33.6160926357009} {:x 2.529999965801835, :y 34.36180520012126} {:x 2.559999965131283, :y 35.11642548858808} {:x 2.5899999644607306, :y 35.879953501101355} {:x 2.6199999637901783, :y 36.65238923766108} {:x 2.649999963119626, :y 37.43373269826728} {:x 2.679999962449074, :y 38.22398388291993} {:x 2.7099999617785215, :y 39.02314279161904} {:x 2.7399999611079693, :y 39.83120942436461} {:x 2.769999960437417, :y 40.64818378115663} {:x 2.7999999597668648, :y 41.47406586199512} {:x 2.8299999590963125, :y 42.308855666880056} {:x 2.8599999584257603, :y 43.15255319581146} {:x 2.889999957755208, :y 44.005158448789324} {:x 2.9199999570846558, :y 44.86667142581364} {:x 2.9499999564141035, :y 45.73709212688441} {:x 2.9799999557435513, :y 46.61642055200165} {:x 3.009999955072999, :y 47.504656701165345} {:x 3.0399999544024467, :y 48.40180057437549} {:x 3.0699999537318945, :y 49.3078521716321} {:x 3.0999999530613422, :y 50.22281149293517} {:x 3.12999995239079, :y 51.1466785382847} {:x 3.1599999517202377, :y 52.07945330768069} {:x 3.1899999510496855, :y 53.02113580112312} {:x 3.2199999503791332, :y 53.97172601861203} {:x 3.249999949708581, :y 54.93122396014739} {:x 3.2799999490380287, :y 55.899629625729204} {:x 3.3099999483674765, :y 56.87694301535749} {:x 3.339999947696924, :y 57.86316412903222} {:x 3.369999947026372, :y 58.85829296675341} {:x 3.3999999463558197, :y 59.862329528521066} {:x 3.4299999456852674, :y 60.87527381433517} {:x 3.459999945014715, :y 61.897125824195754} {:x 3.489999944344163, :y 62.92788555810277} {:x 3.5199999436736107, :y 63.96755301605626} {:x 3.5499999430030584, :y 65.01612819805621} {:x 3.579999942332506, :y 66.0736111041026} {:x 3.609999941661954, :y 67.14000173419545} {:x 3.6399999409914017, :y 68.21530008833479} {:x 3.6699999403208494, :y 69.29950616652056} {:x 3.699999939650297, :y 70.3926199687528} {:x 3.729999938979745, :y 71.49464149503149} {:x 3.7599999383091927, :y 72.60557074535663} {:x 3.7899999376386404, :y 73.72540771972825} {:x 3.819999936968088, :y 74.85415241814633} {:x 3.849999936297536, :y 75.99180484061084} {:x 3.8799999356269836, :y 77.13836498712183} {:x 3.9099999349564314, :y 78.29383285767928} {:x 3.939999934285879, :y 79.45820845228319} {:x 3.969999933615327, :y 80.63149177093355} {:x 3.9999999329447746, :y 81.81368281363036})}), :marks ({:type \"symbol\", :from {:data \"4e436413-20a9-44dd-a1ea-2bb7846f2f52\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}} {:type \"line\", :from {:data \"ebb6c5ea-6be2-4a3a-bae0-d98995af29ff\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; @@
(def num-particles 1)
(def csis-states (take num-particles (infer :csis regress test-data :observe-embedder-input (second test-data))))
(def w-map-csis (empirical-MAP (s/collect-results csis-states)))
w-map-csis
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-double'>3.1621068162122796</span>","value":"3.1621068162122796"},{"type":"html","content":"<span class='clj-double'>3.71794605038581</span>","value":"3.71794605038581"},{"type":"html","content":"<span class='clj-double'>6.220383679082838</span>","value":"6.220383679082838"}],"value":"[3.1621068162122796 3.71794605038581 6.220383679082838]"}
;; <=

;; @@
(plot/compose
  (plot/list-plot (map #(vec [%1 %2]) (first test-data) (second test-data)))
  (plot/plot (partial poly w-map-csis) [(apply min (first test-data)) (apply max (first test-data))]))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"d23d11a3-0962-4f50-8429-9f464a060ee3","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"d23d11a3-0962-4f50-8429-9f464a060ee3","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}],"data":[{"name":"d23d11a3-0962-4f50-8429-9f464a060ee3","values":[{"x":1,"y":20},{"x":2,"y":40},{"x":3,"y":90},{"x":4,"y":160}]},{"name":"113ad830-576c-4707-8297-fcd8b272d48f","values":[{"x":1,"y":13.100436545680928},{"x":1.0299999993294477,"y":13.59079628216312},{"x":1.0599999986588955,"y":14.09235270876713},{"x":1.0899999979883432,"y":14.605105825492958},{"x":1.119999997317791,"y":15.129055632340604},{"x":1.1499999966472387,"y":15.664202129310068},{"x":1.1799999959766865,"y":16.21054531640135},{"x":1.2099999953061342,"y":16.76808519361445},{"x":1.239999994635582,"y":17.33682176094937},{"x":1.2699999939650297,"y":17.916755018406107},{"x":1.2999999932944775,"y":18.50788496598466},{"x":1.3299999926239252,"y":19.11021160368503},{"x":1.359999991953373,"y":19.723734931507224},{"x":1.3899999912828207,"y":20.34845494945123},{"x":1.4199999906122684,"y":20.98437165751706},{"x":1.4499999899417162,"y":21.6314850557047},{"x":1.479999989271164,"y":22.289795144014164},{"x":1.5099999886006117,"y":22.959301922445444},{"x":1.5399999879300594,"y":23.640005390998542},{"x":1.5699999872595072,"y":24.33190554967346},{"x":1.599999986588955,"y":25.035002398470194},{"x":1.6299999859184027,"y":25.749295937388748},{"x":1.6599999852478504,"y":26.474786166429116},{"x":1.6899999845772982,"y":27.211473085591305},{"x":1.719999983906746,"y":27.95935669487531},{"x":1.7499999832361937,"y":28.718436994281138},{"x":1.7799999825656414,"y":29.48871398380878},{"x":1.8099999818950891,"y":30.27018766345824},{"x":1.839999981224537,"y":31.06285803322952},{"x":1.8699999805539846,"y":31.866725093122618},{"x":1.8999999798834324,"y":32.68178884313753},{"x":1.9299999792128801,"y":33.50804928327426},{"x":1.9599999785423279,"y":34.34550641353282},{"x":1.9899999778717756,"y":35.19416023391319},{"x":2.0199999772012234,"y":36.05401074441537},{"x":2.049999976530671,"y":36.92505794503938},{"x":2.079999975860119,"y":37.807301835785196},{"x":2.1099999751895666,"y":38.700742416652844},{"x":2.1399999745190144,"y":39.6053796876423},{"x":2.169999973848462,"y":40.52121364875358},{"x":2.19999997317791,"y":41.44824429998667},{"x":2.2299999725073576,"y":42.386471641341586},{"x":2.2599999718368053,"y":43.33589567281832},{"x":2.289999971166253,"y":44.29651639441687},{"x":2.319999970495701,"y":45.268333806137235},{"x":2.3499999698251486,"y":46.25134790797942},{"x":2.3799999691545963,"y":47.24555869994342},{"x":2.409999968484044,"y":48.250966182029245},{"x":2.439999967813492,"y":49.26757035423688},{"x":2.4699999671429396,"y":50.295371216566345},{"x":2.4999999664723873,"y":51.334368769017615},{"x":2.529999965801835,"y":52.384563011590714},{"x":2.559999965131283,"y":53.44595394428563},{"x":2.5899999644607306,"y":54.518541567102346},{"x":2.6199999637901783,"y":55.6023258800409},{"x":2.649999963119626,"y":56.69730688310126},{"x":2.679999962449074,"y":57.80348457628345},{"x":2.7099999617785215,"y":58.92085895958745},{"x":2.7399999611079693,"y":60.04943003301327},{"x":2.769999960437417,"y":61.189197796560904},{"x":2.7999999597668648,"y":62.34016225023037},{"x":2.8299999590963125,"y":63.50232339402164},{"x":2.8599999584257603,"y":64.67568122793475},{"x":2.889999957755208,"y":65.86023575196964},{"x":2.9199999570846558,"y":67.05598696612637},{"x":2.9499999564141035,"y":68.2629348704049},{"x":2.9799999557435513,"y":69.48107946480528},{"x":3.009999955072999,"y":70.71042074932745},{"x":3.0399999544024467,"y":71.95095872397147},{"x":3.0699999537318945,"y":73.20269338873729},{"x":3.0999999530613422,"y":74.46562474362491},{"x":3.12999995239079,"y":75.73975278863438},{"x":3.1599999517202377,"y":77.02507752376565},{"x":3.1899999510496855,"y":78.32159894901875},{"x":3.2199999503791332,"y":79.62931706439366},{"x":3.249999949708581,"y":80.94823186989038},{"x":3.2799999490380287,"y":82.27834336550893},{"x":3.3099999483674765,"y":83.61965155124929},{"x":3.339999947696924,"y":84.97215642711146},{"x":3.369999947026372,"y":86.33585799309546},{"x":3.3999999463558197,"y":87.7107562492013},{"x":3.4299999456852674,"y":89.09685119542891},{"x":3.459999945014715,"y":90.49414283177836},{"x":3.489999944344163,"y":91.90263115824965},{"x":3.5199999436736107,"y":93.32231617484274},{"x":3.5499999430030584,"y":94.75319788155764},{"x":3.579999942332506,"y":96.19527627839437},{"x":3.609999941661954,"y":97.64855136535292},{"x":3.6399999409914017,"y":99.11302314243326},{"x":3.6699999403208494,"y":100.58869160963545},{"x":3.699999939650297,"y":102.07555676695944},{"x":3.729999938979745,"y":103.57361861440526},{"x":3.7599999383091927,"y":105.0828771519729},{"x":3.7899999376386404,"y":106.60333237966233},{"x":3.819999936968088,"y":108.13498429747361},{"x":3.849999936297536,"y":109.67783290540669},{"x":3.8799999356269836,"y":111.2318782034616},{"x":3.9099999349564314,"y":112.79712019163833},{"x":3.939999934285879,"y":114.37355886993686},{"x":3.969999933615327,"y":115.96119423835722},{"x":3.9999999329447746,"y":117.5600262968994}]}],"marks":[{"type":"symbol","from":{"data":"d23d11a3-0962-4f50-8429-9f464a060ee3"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}},{"type":"line","from":{"data":"113ad830-576c-4707-8297-fcd8b272d48f"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"d23d11a3-0962-4f50-8429-9f464a060ee3\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"d23d11a3-0962-4f50-8429-9f464a060ee3\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"d23d11a3-0962-4f50-8429-9f464a060ee3\", :values ({:x 1, :y 20} {:x 2, :y 40} {:x 3, :y 90} {:x 4, :y 160})} {:name \"113ad830-576c-4707-8297-fcd8b272d48f\", :values ({:x 1, :y 13.100436545680928} {:x 1.0299999993294477, :y 13.59079628216312} {:x 1.0599999986588955, :y 14.09235270876713} {:x 1.0899999979883432, :y 14.605105825492958} {:x 1.119999997317791, :y 15.129055632340604} {:x 1.1499999966472387, :y 15.664202129310068} {:x 1.1799999959766865, :y 16.21054531640135} {:x 1.2099999953061342, :y 16.76808519361445} {:x 1.239999994635582, :y 17.33682176094937} {:x 1.2699999939650297, :y 17.916755018406107} {:x 1.2999999932944775, :y 18.50788496598466} {:x 1.3299999926239252, :y 19.11021160368503} {:x 1.359999991953373, :y 19.723734931507224} {:x 1.3899999912828207, :y 20.34845494945123} {:x 1.4199999906122684, :y 20.98437165751706} {:x 1.4499999899417162, :y 21.6314850557047} {:x 1.479999989271164, :y 22.289795144014164} {:x 1.5099999886006117, :y 22.959301922445444} {:x 1.5399999879300594, :y 23.640005390998542} {:x 1.5699999872595072, :y 24.33190554967346} {:x 1.599999986588955, :y 25.035002398470194} {:x 1.6299999859184027, :y 25.749295937388748} {:x 1.6599999852478504, :y 26.474786166429116} {:x 1.6899999845772982, :y 27.211473085591305} {:x 1.719999983906746, :y 27.95935669487531} {:x 1.7499999832361937, :y 28.718436994281138} {:x 1.7799999825656414, :y 29.48871398380878} {:x 1.8099999818950891, :y 30.27018766345824} {:x 1.839999981224537, :y 31.06285803322952} {:x 1.8699999805539846, :y 31.866725093122618} {:x 1.8999999798834324, :y 32.68178884313753} {:x 1.9299999792128801, :y 33.50804928327426} {:x 1.9599999785423279, :y 34.34550641353282} {:x 1.9899999778717756, :y 35.19416023391319} {:x 2.0199999772012234, :y 36.05401074441537} {:x 2.049999976530671, :y 36.92505794503938} {:x 2.079999975860119, :y 37.807301835785196} {:x 2.1099999751895666, :y 38.700742416652844} {:x 2.1399999745190144, :y 39.6053796876423} {:x 2.169999973848462, :y 40.52121364875358} {:x 2.19999997317791, :y 41.44824429998667} {:x 2.2299999725073576, :y 42.386471641341586} {:x 2.2599999718368053, :y 43.33589567281832} {:x 2.289999971166253, :y 44.29651639441687} {:x 2.319999970495701, :y 45.268333806137235} {:x 2.3499999698251486, :y 46.25134790797942} {:x 2.3799999691545963, :y 47.24555869994342} {:x 2.409999968484044, :y 48.250966182029245} {:x 2.439999967813492, :y 49.26757035423688} {:x 2.4699999671429396, :y 50.295371216566345} {:x 2.4999999664723873, :y 51.334368769017615} {:x 2.529999965801835, :y 52.384563011590714} {:x 2.559999965131283, :y 53.44595394428563} {:x 2.5899999644607306, :y 54.518541567102346} {:x 2.6199999637901783, :y 55.6023258800409} {:x 2.649999963119626, :y 56.69730688310126} {:x 2.679999962449074, :y 57.80348457628345} {:x 2.7099999617785215, :y 58.92085895958745} {:x 2.7399999611079693, :y 60.04943003301327} {:x 2.769999960437417, :y 61.189197796560904} {:x 2.7999999597668648, :y 62.34016225023037} {:x 2.8299999590963125, :y 63.50232339402164} {:x 2.8599999584257603, :y 64.67568122793475} {:x 2.889999957755208, :y 65.86023575196964} {:x 2.9199999570846558, :y 67.05598696612637} {:x 2.9499999564141035, :y 68.2629348704049} {:x 2.9799999557435513, :y 69.48107946480528} {:x 3.009999955072999, :y 70.71042074932745} {:x 3.0399999544024467, :y 71.95095872397147} {:x 3.0699999537318945, :y 73.20269338873729} {:x 3.0999999530613422, :y 74.46562474362491} {:x 3.12999995239079, :y 75.73975278863438} {:x 3.1599999517202377, :y 77.02507752376565} {:x 3.1899999510496855, :y 78.32159894901875} {:x 3.2199999503791332, :y 79.62931706439366} {:x 3.249999949708581, :y 80.94823186989038} {:x 3.2799999490380287, :y 82.27834336550893} {:x 3.3099999483674765, :y 83.61965155124929} {:x 3.339999947696924, :y 84.97215642711146} {:x 3.369999947026372, :y 86.33585799309546} {:x 3.3999999463558197, :y 87.7107562492013} {:x 3.4299999456852674, :y 89.09685119542891} {:x 3.459999945014715, :y 90.49414283177836} {:x 3.489999944344163, :y 91.90263115824965} {:x 3.5199999436736107, :y 93.32231617484274} {:x 3.5499999430030584, :y 94.75319788155764} {:x 3.579999942332506, :y 96.19527627839437} {:x 3.609999941661954, :y 97.64855136535292} {:x 3.6399999409914017, :y 99.11302314243326} {:x 3.6699999403208494, :y 100.58869160963545} {:x 3.699999939650297, :y 102.07555676695944} {:x 3.729999938979745, :y 103.57361861440526} {:x 3.7599999383091927, :y 105.0828771519729} {:x 3.7899999376386404, :y 106.60333237966233} {:x 3.819999936968088, :y 108.13498429747361} {:x 3.849999936297536, :y 109.67783290540669} {:x 3.8799999356269836, :y 111.2318782034616} {:x 3.9099999349564314, :y 112.79712019163833} {:x 3.939999934285879, :y 114.37355886993686} {:x 3.969999933615327, :y 115.96119423835722} {:x 3.9999999329447746, :y 117.5600262968994})}), :marks ({:type \"symbol\", :from {:data \"d23d11a3-0962-4f50-8429-9f464a060ee3\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}} {:type \"line\", :from {:data \"113ad830-576c-4707-8297-fcd8b272d48f\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; @@

;; @@
